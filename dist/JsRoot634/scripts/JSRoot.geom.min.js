var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(r,f,g){r!=Array.prototype&&r!=Object.prototype&&(r[f]=g.value)};$jscomp.getGlobal=function(r){return"undefined"!=typeof window&&window===r?r:"undefined"!=typeof global&&null!=global?global:r};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(r,f,g,n){if(f){g=$jscomp.global;r=r.split(".");for(n=0;n<r.length-1;n++){var u=r[n];u in g||(g[u]={});g=g[u]}r=r[r.length-1];n=g[r];f=f(n);f!=n&&null!=f&&$jscomp.defineProperty(g,r,{configurable:!0,writable:!0,value:f})}};$jscomp.polyfill("Number.isFinite",function(r){return r?r:function(f){return"number"!==typeof f?!1:!isNaN(f)&&Infinity!==f&&-Infinity!==f}},"es6","es3");
$jscomp.arrayIteratorImpl=function(r){var f=0;return function(){return f<r.length?{done:!1,value:r[f++]}:{done:!0}}};$jscomp.arrayIterator=function(r){return{next:$jscomp.arrayIteratorImpl(r)}};$jscomp.makeIterator=function(r){var f="undefined"!=typeof Symbol&&Symbol.iterator&&r[Symbol.iterator];return f?f.call(r):$jscomp.arrayIterator(r)};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(r){function f(){this.batch_=null}function g(d){return d instanceof u?d:new u(function(f,a){f(d)})}if(r&&!$jscomp.FORCE_POLYFILL_PROMISE)return r;f.prototype.asyncExecute=function(d){if(null==this.batch_){this.batch_=[];var f=this;this.asyncExecuteFunction(function(){f.executeBatch_()})}this.batch_.push(d)};var n=$jscomp.global.setTimeout;f.prototype.asyncExecuteFunction=function(d){n(d,0)};f.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var d=
this.batch_;this.batch_=[];for(var f=0;f<d.length;++f){var a=d[f];d[f]=null;try{a()}catch(b){this.asyncThrow_(b)}}}this.batch_=null};f.prototype.asyncThrow_=function(d){this.asyncExecuteFunction(function(){throw d;})};var u=function(d){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var f=this.createResolveAndReject_();try{d(f.resolve,f.reject)}catch(a){f.reject(a)}};u.prototype.createResolveAndReject_=function(){function d(b){return function(c){a||(a=!0,b.call(f,c))}}var f=this,a=!1;
return{resolve:d(this.resolveTo_),reject:d(this.reject_)}};u.prototype.resolveTo_=function(d){if(d===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(d instanceof u)this.settleSameAsPromise_(d);else{a:switch(typeof d){case "object":var f=null!=d;break a;case "function":f=!0;break a;default:f=!1}f?this.resolveToNonPromiseObj_(d):this.fulfill_(d)}};u.prototype.resolveToNonPromiseObj_=function(d){var f=void 0;try{f=d.then}catch(a){this.reject_(a);return}"function"==typeof f?
this.settleSameAsThenable_(f,d):this.fulfill_(d)};u.prototype.reject_=function(d){this.settle_(2,d)};u.prototype.fulfill_=function(d){this.settle_(1,d)};u.prototype.settle_=function(d,f){if(0!=this.state_)throw Error("Cannot settle("+d+", "+f+"): Promise already settled in state"+this.state_);this.state_=d;this.result_=f;this.executeOnSettledCallbacks_()};u.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var d=0;d<this.onSettledCallbacks_.length;++d)y.asyncExecute(this.onSettledCallbacks_[d]);
this.onSettledCallbacks_=null}};var y=new f;u.prototype.settleSameAsPromise_=function(d){var f=this.createResolveAndReject_();d.callWhenSettled_(f.resolve,f.reject)};u.prototype.settleSameAsThenable_=function(d,f){var a=this.createResolveAndReject_();try{d.call(f,a.resolve,a.reject)}catch(b){a.reject(b)}};u.prototype.then=function(f,g){function a(a,e){return"function"==typeof a?function(e){try{b(a(e))}catch(m){c(m)}}:e}var b,c,e=new u(function(a,e){b=a;c=e});this.callWhenSettled_(a(f,b),a(g,c));return e};
u.prototype.catch=function(f){return this.then(void 0,f)};u.prototype.callWhenSettled_=function(f,g){function a(){switch(b.state_){case 1:f(b.result_);break;case 2:g(b.result_);break;default:throw Error("Unexpected state: "+b.state_);}}var b=this;null==this.onSettledCallbacks_?y.asyncExecute(a):this.onSettledCallbacks_.push(a)};u.resolve=g;u.reject=function(f){return new u(function(d,a){a(f)})};u.race=function(f){return new u(function(d,a){for(var b=$jscomp.makeIterator(f),c=b.next();!c.done;c=b.next())g(c.value).callWhenSettled_(d,
a)})};u.all=function(f){var d=$jscomp.makeIterator(f),a=d.next();return a.done?g([]):new u(function(b,c){function e(a){return function(c){h[a]=c;k--;0==k&&b(h)}}var h=[],k=0;do h.push(void 0),k++,g(a.value).callWhenSettled_(e(h.length-1),c),a=d.next();while(!a.done)})};return u},"es6","es3");
JSROOT.define(["d3","three","geobase","painter","base3d"],function(r,f,g,n){function u(a,b){this.bright=b;this.element=a.append("div").attr("class","geo_toolbar_group")}function y(a,b){n.InteractiveControl.call(this);this.mesh=a&&a.material?a:null;this.bloom=b}function d(a,b){b&&"TGeoManager"===b._typename&&(this.geo_manager=b,b=b.fMasterVolume);b&&0===b._typename.indexOf("TGeoVolume")&&(b={_typename:"TGeoNode",fVolume:b,fName:b.fName,$geoh:b.$geoh,_proxy:!0});JSROOT.ObjectPainter.call(this,a,b);
this.mode3d=this.no_default_title=!0;this.drawing_stage=0;this.ctrl={clipIntersect:!0,clip:[{name:"x",enabled:!1,value:0,min:-100,max:100},{name:"y",enabled:!1,value:0,min:-100,max:100},{name:"z",enabled:!1,value:0,min:-100,max:100}],ssao:{enabled:!1,output:f.SSAOPass.OUTPUT.Default,kernelRadius:0,minDistance:.001,maxDistance:.1},bloom:{enabled:!0,strength:1.5},info:{num_meshes:0,num_faces:0,num_shapes:0},highlight:!1,highlight_scene:!1,depthTest:!0,depthMethod:"dflt",select_in_view:!1,update_browser:!0,
light:{kind:"points",top:!1,bottom:!1,left:!1,right:!1,front:!1,specular:!0,power:1},trans_radial:0,trans_z:0};this.ctrl.depthMethodItems=[{name:"Default",value:"dflt"},{name:"Raytraicing",value:"ray"},{name:"Boundary box",value:"box"},{name:"Mesh size",value:"size"},{name:"Central point",value:"pnt"}];this.ctrl.ssao.outputItems=[{name:"Default",value:f.SSAOPass.OUTPUT.Default},{name:"SSAO Only",value:f.SSAOPass.OUTPUT.SSAO},{name:"SSAO Only + Blur",value:f.SSAOPass.OUTPUT.Blur},{name:"Beauty",value:f.SSAOPass.OUTPUT.Beauty},
{name:"Depth",value:f.SSAOPass.OUTPUT.Depth},{name:"Normal",value:f.SSAOPass.OUTPUT.Normal}];this.cleanup(!0)}JSROOT.loadScript("$$$style/JSRoot.geom");u.prototype.addButtons=function(a){var b=this;this.buttonsNames=[];JSROOT.require(["interactive"]).then(function(c){a.forEach(function(a){var e=a.name;if(!e)throw Error("must provide button 'name' in button config");if(-1!==b.buttonsNames.indexOf(e))throw Error("button name '"+e+"' is taken");b.buttonsNames.push(e);e=a.title||a.name;if("function"!==
typeof a.click)throw Error("must provide button 'click' function in button config");var k=b.element.append("a").attr("class",b.bright?"geo_toolbar_btn_bright":"geo_toolbar_btn").attr("rel","tooltip").attr("data-title",e).on("click",a.click);c.ToolbarIcons.createSVG(k,c.ToolbarIcons[a.icon],16,e)})})};u.prototype.changeBrightness=function(a){this.bright=a;this.element&&this.element.selectAll(a?".geo_toolbar_btn":".geo_toolbar_btn_bright").attr("class",a?"geo_toolbar_btn_bright":"geo_toolbar_btn")};
u.prototype.cleanup=function(){this.element&&(this.element.remove(),delete this.element)};y.prototype=Object.create(n.InteractiveControl.prototype);y.prototype.setHighlight=function(a,b){return this.drawSpecial(a,b)};y.prototype.drawSpecial=function(a){var b=this.mesh;if(b&&b.material){if(a)return b.origin||(b.origin={color:b.material.color,emissive:b.material.emissive,opacity:b.material.opacity,width:b.material.linewidth,size:b.material.size}),this.bloom?(b.layers.enable(1),b.material.emissive=new f.Color(65280)):
(b.material.color=new f.Color(a),b.material.opacity=1),b.hightlightWidthScale&&!JSROOT.browser.isWin&&(b.material.linewidth=b.origin.width*b.hightlightWidthScale),b.highlightScale&&(b.material.size=b.origin.size*b.highlightScale),!0;if(b.origin)return this.bloom?(b.material.emissive=b.origin.emissive,b.layers.enable(0)):(b.material.color=b.origin.color,b.material.opacity=b.origin.opacity),b.hightlightWidthScale&&(b.material.linewidth=b.origin.width),b.highlightScale&&(b.material.size=b.origin.size),
!0}};d.prototype=Object.create(JSROOT.ObjectPainter.prototype);d.prototype.createToolbar=function(){var a=this;if(!this._toolbar&&this._webgl&&!this.ctrl.notoolbar&&!JSROOT.batch_mode){var b=[{name:"toImage",title:"Save as PNG",icon:"camera",click:function(){return a.createSnapshot()}},{name:"control",title:"Toggle control UI",icon:"rect",click:function(){return a.showControlOptions("toggle")}},{name:"enlarge",title:"Enlarge geometry drawing",icon:"circle",click:function(){return a.toggleEnlarge()}}];
navigator.getVRDisplays&&(b.push({name:"entervr",title:"Enter VR (It requires a VR Headset connected)",icon:"vrgoggles",click:function(){return a.toggleVRMode()}}),this.initVRMode());JSROOT.settings.ContextMenu&&b.push({name:"menu",title:"Show context menu",icon:"question",click:function(b){b.preventDefault();b.stopPropagation();n.closeMenu&&n.closeMenu()||n.createMenu(b,a).then(function(a){a.painter.fillContextMenu(a);a.show()})}});var c=new f.Color(this.ctrl.background);this._toolbar=new u(this.selectDom(),
1>c.r+c.g+c.b);this._toolbar.addButtons(b)}};d.prototype.initVRMode=function(){var a=this;this._dolly=new f.Group;this._scene.add(this._dolly);this._standingMatrix=new f.Matrix4;this._raycasterEnd=new f.Vector3;this._raycasterOrigin=new f.Vector3;navigator.getVRDisplays().then(function(b){if(b=b[0])a._renderer.vr.setDevice(b),a._vrDisplay=b,b.stageParameters&&a._standingMatrix.fromArray(b.stageParameters.sittingToStandingTransform),a.initVRControllersGeometry()})};d.prototype.initVRControllersGeometry=
function(){var a=new f.SphereGeometry(.025,18,36),b=new f.MeshBasicMaterial({color:"grey"}),c=new f.MeshBasicMaterial({color:"fuchsia"}),e=new f.BoxBufferGeometry(.001,.001,2),h=new f.Mesh(e,c);c=new f.Mesh(e,c);e=new f.Mesh(a,b);a=new f.Mesh(a,b);this._controllersMeshes=[];this._controllersMeshes.push(e);this._controllersMeshes.push(a);--h.position.z;--c.position.z;e.add(h);a.add(c);this._dolly.add(e);this._dolly.add(a);e.visible=!1;a.visible=!1};d.prototype.updateVRControllersList=function(){var a=
navigator.getGamepads&&navigator.getGamepads();if(!this.vrControllers||a.length!==this.vrControllers.length){this._controllersMeshes.forEach(function(a){a.visible=!1});this._vrControllers=[];for(var b=0;b<a.length;++b)a[b]&&a[b].pose&&(this._vrControllers.push({gamepad:a[b],mesh:this._controllersMeshes[b]}),this._controllersMeshes[b].visible=!0)}};d.prototype.processVRControllerIntersections=function(){for(var a=[],b=0;b<this._vrControllers.length;++b){var c=this._vrControllers[b].mesh,e=c.localToWorld(this._raycasterEnd.set(0,
0,-1));c=c.localToWorld(this._raycasterOrigin.set(0,0,0));e.sub(c).normalize();a=a.concat(this._controls.getOriginDirectionIntersects(c,e))}a=a.filter(function(b,c){return a.indexOf(b)===c});this._controls.ProcessMouseMove(a)};d.prototype.updateVRControllers=function(){this.updateVRControllersList();for(var a=0;a<this._vrControllers.length;++a){var b=this._vrControllers[a],c=b.gamepad.pose.orientation,e=b.gamepad.pose.position;b=b.mesh;c&&b.quaternion.fromArray(c);e&&b.position.fromArray(e);b.updateMatrix();
b.applyMatrix4(this._standingMatrix);b.matrixWorldNeedsUpdate=!0}this.processVRControllerIntersections()};d.prototype.toggleVRMode=function(){var a=this;this._vrDisplay&&(this._vrDisplay.isPresenting?this.exitVRMode():(this._previousCameraPosition=this._camera.position.clone(),this._previousCameraRotation=this._camera.rotation.clone(),this._vrDisplay.requestPresent([{source:this._renderer.domElement}]).then(function(){a._previousCameraNear=a._camera.near;a._dolly.position.set(a._camera.position.x/
4,-a._camera.position.y/8,-a._camera.position.z/4);a._camera.position.set(0,0,0);a._dolly.add(a._camera);a._camera.near=.1;a._camera.updateProjectionMatrix();a._renderer.vr.enabled=!0;a._renderer.setAnimationLoop(function(){a.updateVRControllers();a.render3D(0)})}),this._renderer.vr.enabled=!0,window.addEventListener("keydown",function(b){27===b.keyCode&&a.exitVRMode()})))};d.prototype.exitVRMode=function(){this._vrDisplay.isPresenting&&(this._renderer.vr.enabled=!1,this._dolly.remove(this._camera),
this._scene.add(this._camera),this._camera.position.copy(this._previousCameraPosition),this._previousCameraPosition=void 0,this._camera.rotation.copy(this._previousCameraRotation),this._previousCameraRotation=void 0,this._camera.near=this._previousCameraNear,this._camera.updateProjectionMatrix(),this._vrDisplay.exitPresent())};d.prototype.getGeometry=function(){return this.getObject()};d.prototype.modifyVisisbility=function(a,b){if(0===g.getNodeKind(this.getGeometry())){if(""==a)return g.SetBit(this.getGeometry().fVolume,
g.BITS.kVisThis,"+"===b);var c=!1;0>a.indexOf("*")?(a=new RegExp("^"+a+"$"),c=!0):(a=new RegExp("^"+a.split("*").join(".*")+"$"),c=!1);this.findNodeWithVolume(a,function(a){g.setInvisibleAll(a.node.fVolume,"+"!==b);return c?a:null})}};d.prototype.decodeOptions=function(a){"string"!=typeof a&&(a="");var b={_grid:!1,_bound:!1,_debug:!1,_full:!1,_axis:0,_count:!1,wireframe:!1,scale:new f.Vector3(1,1,1),zoom:1,rotatey:0,rotatez:0,more:1,maxlimit:1E5,vislevel:void 0,maxnodes:void 0,dflt_colors:!1,use_worker:!1,
show_controls:!1,highlight:!1,highlight_scene:!1,no_screen:!1,project:"",is_main:!1,tracks:!1,showtop:!1,can_rotate:!0,ortho_camera:!1,clipx:!1,clipy:!1,clipz:!1,usessao:!1,usebloom:!0,outline:!1,script_name:"",transparency:0,rotate:!1,background:"#FFFFFF",depthMethod:"dflt",mouse_tmout:50,trans_radial:0,trans_z:0},c=JSROOT.decodeUrl();"true"==c.get("_grid")&&(b._grid=!0);c=c.get("_debug");"true"==c&&(b._debug=!0,b._grid=!0);"bound"==c&&(b._debug=!0,b._grid=!0,b._bound=!0);"full"==c&&(b._debug=!0,
b._grid=!0,b._full=!0,b._bound=!0);c=a.indexOf("macro:");if(0<=c){var e=a.indexOf(";",c+6);0>e&&(e=a.length);b.script_name=a.substr(c+6,e-c-6);a=a.substr(0,c)+a.substr(e+1);console.log("script",b.script_name,"rest",a)}for(;;){var h=a.indexOf("+"),k=a.indexOf("-");if(0>h&&0>k)break;c=h;e="+";if(0>c||0<=k&&k<h)c=k,e="-";h=c+1;for(k=/[,; .]/;h<a.length&&!k.test(a[h])&&"+"!=a[h]&&"-"!=a[h];)h++;k=a.substring(c+1,h);a=a.substr(0,c)+a.substr(h);this.modifyVisisbility(k,e)}a=new JSROOT.DrawOptions(a);a.check("MAIN")&&
(b.is_main=!0);a.check("TRACKS")&&(b.tracks=!0);a.check("SHOWTOP")&&(b.showtop=!0);a.check("NO_SCREEN")&&(b.no_screen=!0);a.check("ORTHO_CAMERA_ROTATE")&&(b.ortho_camera=!0,b.can_rotate=!0);a.check("ORTHO_CAMERA")&&(b.ortho_camera=!0,b.can_rotate=!1);a.check("MOUSE_CLICK")&&(b.mouse_click=!0);if(a.check("DEPTHRAY")||a.check("DRAY"))b.depthMethod="ray";if(a.check("DEPTHBOX")||a.check("DBOX"))b.depthMethod="box";if(a.check("DEPTHPNT")||a.check("DPNT"))b.depthMethod="pnt";if(a.check("DEPTHSIZE")||a.check("DSIZE"))b.depthMethod=
"size";if(a.check("DEPTHDFLT")||a.check("DDFLT"))b.depthMethod="dflt";a.check("ZOOM",!0)&&(b.zoom=a.partAsFloat(0,100)/100);a.check("ROTY",!0)&&(b.rotatey=a.partAsFloat());a.check("ROTZ",!0)&&(b.rotatez=a.partAsFloat());a.check("VISLVL",!0)&&(b.vislevel=a.partAsInt());a.check("BLACK")&&(b.background="#000000");a.check("WHITE")&&(b.background="#FFFFFF");if(a.check("BKGR_",!0)){c=null;if(0<a.partAsInt(1))c=n.getColor(a.partAsInt());else for(e=0;8>e;++e)n.getColor(e).toUpperCase()===a.part&&(c=n.getColor(e));
c&&(b.background="#"+(new f.Color(c)).getHexString())}a.check("R3D_",!0)&&(b.Render3D=JSROOT.constants.Render3D.fromString(a.part.toLowerCase()));a.check("MORE3")&&(b.more=3);a.check("MORE")&&(b.more=2);a.check("ALL")&&(b.more=10,b.vislevel=9);if(a.check("CONTROLS")||a.check("CTRL"))b.show_controls=!0;a.check("CLIPXYZ")&&(b.clipx=b.clipy=b.clipz=!0);a.check("CLIPX")&&(b.clipx=!0);a.check("CLIPY")&&(b.clipy=!0);a.check("CLIPZ")&&(b.clipz=!0);a.check("CLIP")&&(b.clipx=b.clipy=b.clipz=!0);a.check("PROJX",
!0)&&(b.project="x",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);a.check("PROJY",!0)&&(b.project="y",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);a.check("PROJZ",!0)&&(b.project="z",0<a.partAsInt(1)&&(b.projectPos=a.partAsInt()),b.can_rotate=!1);if(a.check("DFLT_COLORS")||a.check("DFLT"))b.dflt_colors=!0;a.check("SSAO")&&(b.usessao=!0);a.check("NOBLOOM")&&(b.usebloom=!1);a.check("BLOOM")&&(b.usebloom=!0);a.check("OUTLINE")&&(b.outline=!0);a.check("NOWORKER")&&
(b.use_worker=-1);a.check("WORKER")&&(b.use_worker=1);if(a.check("NOHIGHLIGHT")||a.check("NOHIGH"))b.highlight_scene=b.highlight=0;a.check("HIGHLIGHT")&&(b.highlight_scene=b.highlight=!0);a.check("HSCENEONLY")&&(b.highlight_scene=!0,b.highlight=0);a.check("NOHSCENE")&&(b.highlight_scene=0);a.check("HSCENE")&&(b.highlight_scene=!0);if(a.check("WIREFRAME")||a.check("WIRE"))b.wireframe=!0;a.check("ROTATE")&&(b.rotate=!0);if(a.check("INVX")||a.check("INVERTX"))b.scale.x=-1;if(a.check("INVY")||a.check("INVERTY"))b.scale.y=
-1;if(a.check("INVZ")||a.check("INVERTZ"))b.scale.z=-1;a.check("COUNT")&&(b._count=!0);a.check("TRANSP",!0)&&(b.transparency=a.partAsInt(0,100)/100);a.check("OPACITY",!0)&&(b.transparency=1-a.partAsInt(0,100)/100);if(a.check("AXISCENTER")||a.check("AC"))b._axis=2;a.check("TRR",!0)&&(b.trans_radial=a.partAsInt()/100);a.check("TRZ",!0)&&(b.trans_z=a.partAsInt()/100);if(a.check("AXIS")||a.check("A"))b._axis=!0;a.check("D")&&(b._debug=!0);a.check("G")&&(b._grid=!0);a.check("B")&&(b._bound=!0);a.check("W")&&
(b.wireframe=!0);a.check("F")&&(b._full=!0);a.check("Y")&&(b._yup=!0);a.check("Z")&&(b._yup=!1);void 0===b._yup&&(b._yup=this.getCanvSvg().empty());return b};d.prototype.activateInBrowser=function(a,b){var c=this;"string"==typeof a&&(a=[a]);this._hpainter&&(this._hpainter.activateItems(a,b),this.ctrl.update_browser||setTimeout(function(){return c._hpainter.activateItems([])},2E3))};d.prototype.testMatrixes=function(){var a=this,b=0,c=0,e=0,h=(new Date).getTime();this._clones.scanVisible({domatrix:!0,
func:function(){var h=a.getmatrix(),k=a.CopyStack(),d=a._clones.createObject3D(k.stack,a._toplevel,"mesh");if(!d)return!0;c++;d=d.matrixWorld;if(d.equals(h))return!0;if(0<d.determinant()&&-.9>h.determinant()){var g=f.Vector3(1,1,-1);h=h.clone().scale(g);if(d.equals(h))return!0}for(var t=g=0;16>t;++t)g=Math.max(g,Math.abs(d.elements[t]-h.elements[t]));e=Math.max(g,e);if(1E-4>g)return!0;console.log(a._clones.resolveStack(k.stack).name,"maxdiff",g,"determ",d.determinant(),h.determinant());b++;return!1}});
var k=(new Date).getTime();console.log("Compare matrixes total",c,"errors",b,"takes",k-h,"maxdiff",e)};d.prototype.fillContextMenu=function(a){var b=this;a.add("header: Draw options");a.addchk(this.ctrl.update_browser,"Browser update",function(){b.ctrl.update_browser=!b.ctrl.update_browser;b.ctrl.update_browser||b.activateInBrowser([])});a.addchk(this.ctrl.show_controls,"Show Controls",function(){return b.showControlOptions("toggle")});a.addchk(this.ctrl._axis,"Show axes",function(){return b.setAxesDraw("toggle")});
this.geo_manager&&a.addchk(this.ctrl.showtop,"Show top volume",function(){return b.setShowTop(!b.ctrl.showtop)});a.addchk(this.ctrl.wireframe,"Wire frame",function(){return b.toggleWireFrame()});a.addchk(this.ctrl.highlight,"Highlight volumes",function(){b.ctrl.highlight=!b.ctrl.highlight});a.addchk(this.ctrl.highlight_scene,"Highlight scene",function(){b.ctrl.highlight_scene=!b.ctrl.highlight_scene});a.add("Reset camera position",function(){return b.focusCamera()});this._geom_viewer||a.add("Get camera position",
function(){return a.info("Position (as url)","&opt="+b.produceCameraUrl())});this.ctrl.project||a.addchk(this.ctrl.rotate,"Autorotate",function(){return b.setAutoRotate(!b.ctrl.rotate)});a.addchk(this.ctrl.select_in_view,"Select in view",function(){b.ctrl.select_in_view=!b.ctrl.select_in_view;b.ctrl.select_in_view&&b.startDrawGeometry()})};d.prototype.changedGlobalTransparency=function(a,b){var c="function"==typeof a?a:null;if(c||void 0===a)a=this.ctrl.transparency;this._toplevel.traverse(function(b){if(b&&
b.material&&void 0!==b.material.inherentOpacity){var e=c?c(b):void 0;b.material.opacity=void 0!==e?1-e:Math.min(1-(a||0),b.material.inherentOpacity);b.material.transparent=1>b.material.opacity}});b||this.render3D(-1)};d.prototype.resetTransformation=function(){this.changedTransformation("reset")};d.prototype.changedTransformation=function(a){if(this._toplevel){var b=this.ctrl,c=new f.Matrix4,e=new f.Vector3;"reset"==a&&(b.trans_z=b.trans_radial=0);this._toplevel.traverse(function(h){if(void 0!==h.stack){var k=
h.parent;if("reset"==a)k.matrix0&&(k.matrix.copy(k.matrix0),k.matrix.decompose(k.position,k.quaternion,k.scale),k.matrixWorldNeedsUpdate=!0),delete k.matrix0,delete k.vect0,delete k.vect1,delete k.minvert;else{if(void 0===k.vect0){k.matrix0=k.matrix.clone();k.minvert=(new f.Matrix4).copy(k.matrixWorld).invert();var d=g.getBoundingBox(h,null,!0);k.vect0=(new f.Vector3((d.max.x+d.min.x)/2,(d.max.y+d.min.y)/2,(h._flippedMesh?-1:1)*(d.max.z+d.min.z)/2)).applyMatrix4(k.matrixWorld);k.vect1=(new f.Vector3(0,
0,0)).applyMatrix4(k.minvert)}e.set(b.trans_radial*k.vect0.x,b.trans_radial*k.vect0.y,b.trans_z*k.vect0.z).applyMatrix4(k.minvert).sub(k.vect1);k.matrix.multiplyMatrices(k.matrix0,c.makeTranslation(e.x,e.y,e.z));k.matrix.decompose(k.position,k.quaternion,k.scale);k.matrixWorldNeedsUpdate=!0}}});this._toplevel.updateMatrixWorld();"norender"!=a&&this.drawSimpleAxis()}};d.prototype.changedAutoRotate=function(){this.autorotate(2.5)};d.prototype.changedAxes=function(){"string"==typeof this.ctrl._axis&&
(this.ctrl._axis=parseInt(this.ctrl._axis));this.drawSimpleAxis()};d.prototype.changedBackground=function(a){void 0!==a&&(this.ctrl.background=a);this._renderer.setClearColor(this.ctrl.background,1);this.render3D(0);this._toolbar&&(a=new f.Color(this.ctrl.background),this._toolbar.changeBrightness(1>a.r+a.g+a.b))};d.prototype.changedSSAO=function(){var a=this;this.ctrl.ssao.enabled?(this.createSSAO(),this._ssaoPass.output=parseInt(this.ctrl.ssao.output),this._ssaoPass.kernelRadius=this.ctrl.ssao.kernelRadius,
this._ssaoPass.minDistance=this.ctrl.ssao.minDistance,this._ssaoPass.maxDistance=this.ctrl.ssao.maxDistance):this.removeSSAO();this.updateClipping();this._slave_painters&&this._slave_painters.forEach(function(b){JSROOT.extend(b.ctrl.ssao,a.ctrl.ssao);b.changedSSAO()})};d.prototype.showControlOptions=function(a){var b=this;this.ctrl&&("toggle"===a?a=!this._datgui:void 0===a&&(a=this.ctrl.show_controls),this.ctrl.show_controls=a,this._datgui?a||(r.select(this._datgui.domElement).remove(),this._datgui.destroy(),
delete this._datgui):a&&JSROOT.require("dat.gui").then(function(a){return b.buildDatGui(a)}))};d.prototype.buildDatGui=function(a){var b=this;if(this._renderer){if(!a)throw Error("Fail to load dat.gui");this._datgui=new a.GUI({autoPlace:!1,width:Math.min(650,this._renderer.domElement.width/2)});a=this.selectDom();"static"==a.style("position")&&a.style("position","relative");r.select(this._datgui.domElement).style("position","absolute").style("top",0).style("right",0);a.node().appendChild(this._datgui.domElement);
this._datgui.painter=this;if(this.ctrl.project){a=this.getGeomBoundingBox(this.getProjectionSource(),.01);var c=this.ctrl.project;void 0===this.ctrl.projectPos&&(this.ctrl.projectPos=(a.min[c]+a.max[c])/2);this._datgui.add(this.ctrl,"projectPos",a.min[c],a.max[c]).name(c.toUpperCase()+" projection").onChange(this.startDrawGeometry.bind(this))}else{a=this._datgui.addFolder("Clipping");c=this.changedClipping.bind(this,-1);for(var e=0;3>e;++e){var h=this.ctrl.clip[e],k=h.name.toUpperCase();a.add(h,"enabled").name("Enable "+
k).listen().onChange(c);a.add(h,"value",h.min,h.max).name(k+" position").onChange(this.changedClipping.bind(this,e))}a.add(this.ctrl,"clipIntersect").name("Clip intersection").listen().onChange(c)}a=this._datgui.addFolder("Appearance");a.add(this.ctrl,"highlight").name("Highlight Selection").listen().onChange(this.changedHighlight.bind(this));a.add(this.ctrl,"transparency",0,1,.001).listen().onChange(this.changedGlobalTransparency.bind(this));a.addColor(this.ctrl,"background").name("Background").onChange(this.changedBackground.bind(this));
a.add(this.ctrl,"wireframe").name("Wireframe").listen().onChange(this.changedWireFrame.bind(this));this.ctrl._axis_cfg=0;a.add(this.ctrl,"_axis",{none:0,show:1,center:2}).name("Axes").onChange(this.changedAxes.bind(this));if(!this.ctrl.project)a.add(this.ctrl,"rotate").name("Autorotate").listen().onChange(this.changedAutoRotate.bind(this));a.add(this,"focusCamera").name("Reset camera position");if(this._webgl){a=this._datgui.addFolder("Advanced");var f={};this.ctrl.depthMethodItems.forEach(function(a){f[a.name]=
a.value});a.add(this.ctrl,"depthTest").name("Depth test").listen().onChange(this.changedDepthTest.bind(this));a.add(this.ctrl,"depthMethod",f).name("Rendering order").onChange(this.changedDepthMethod.bind(this));a.add(this.ctrl,"ortho_camera").name("Orhographic camera").listen().onChange(function(){return b.changeCamera()});a.add(this,"resetAdvanced").name("Reset")}this.ctrl.project||(a=this._datgui.addFolder("Transform"),a.add(this.ctrl,"trans_z",0,3,.01).name("Z axis").listen().onChange(this.changedTransformation.bind(this)),
a.add(this.ctrl,"trans_radial",0,3,.01).name("Radial").listen().onChange(this.changedTransformation.bind(this)),a.add(this,"resetTransformation").name("Reset"),(this.ctrl.trans_z||this.ctrl.trans_radial)&&a.open());if(!this.ctrl.outline){a=this._datgui.addFolder("Smooth Lighting (SSAO)");c=this.changedSSAO.bind(this);var d={};this.ctrl.ssao.outputItems.forEach(function(a){d[a.name]=a.value});a.add(this.ctrl.ssao,"enabled").name("Enable SSAO").listen().onChange(c);a.add(this.ctrl.ssao,"output",d).listen().onChange(c);
a.add(this.ctrl.ssao,"kernelRadius",0,32).listen().onChange(c);a.add(this.ctrl.ssao,"minDistance",.001,.02).listen().onChange(c);a.add(this.ctrl.ssao,"maxDistance",.01,.3).listen().onChange(c);a=this._datgui.addFolder("Unreal Bloom");c=this.changedBloomSettings.bind(this);a.add(this.ctrl.bloom,"enabled").name("Enable Blooming").listen().onChange(c);a.add(this.ctrl.bloom,"strength",0,3).name("Strength").listen().onChange(c)}}};d.prototype.changedBloomSettings=function(){var a=this;this.ctrl.bloom.enabled?
(this.createBloom(),this._bloomPass.strength=this.ctrl.bloom.strength):this.removeBloom();this._slave_painters&&this._slave_painters.forEach(function(b){JSROOT.extend(b.ctrl.bloom,a.ctrl.bloom);b.changedBloomSettings()})};d.prototype.changeCamera=function(){this._controls&&(this._controls.cleanup(),delete this._controls);this.removeBloom();this.removeSSAO();this.createCamera();this.createSpecialEffects();this._first_drawing=!0;this.startDrawGeometry(!0)};d.prototype.createBloom=function(){this._bloomPass||
(this._camera.layers.enable(1),this._bloomComposer=new f.EffectComposer(this._renderer),this._bloomComposer.addPass(new f.RenderPass(this._scene,this._camera)),this._bloomPass=new f.UnrealBloomPass(new f.Vector2(window.innerWidth,window.innerHeight),1.5,.4,.85),this._bloomPass.threshold=0,this._bloomPass.strength=this.ctrl.bloom.strength,this._bloomPass.radius=0,this._bloomPass.renderToScreen=!0,this._bloomComposer.addPass(this._bloomPass),this._renderer.autoClear=!1)};d.prototype.removeBloom=function(){this._bloomPass&&
(delete this._bloomPass,delete this._bloomComposer,this._renderer.autoClear=!0,this._camera.layers.disable(1))};d.prototype.removeSSAO=function(){delete this._ssaoPass;delete this._effectComposer};d.prototype.createSSAO=function(){this._webgl&&!this._ssaoPass&&(this._effectComposer||(this._effectComposer=new f.EffectComposer(this._renderer),this._effectComposer.addPass(new f.RenderPass(this._scene,this._camera))),this._ssaoPass=new f.SSAOPass(this._scene,this._camera,this._scene_width,this._scene_height),
this._ssaoPass.kernelRadius=16,this._ssaoPass.renderToScreen=!0,this._effectComposer.addPass(this._ssaoPass))};d.prototype.orbitContext=function(a,b){var c=this;n.createMenu(a,this).then(function(a){var e=0,k=0,f=0;if(b)for(var d=0;d<b.length;++d)b[d].object.stack&&k++,b[d].object.geo_name&&e++;if(0===k+e)c.fillContextMenu(a);else for((k=1<k+e)&&a.add("header:"+(0<e?"Items":"Nodes")),e=0;e<b.length;++e){d=b[e].object;var p=void 0,l=void 0,t=void 0;if(d.geo_name)l=d.geo_name,0==l.indexOf("<prnt>")&&
(l=(c.getItemName()||"top")+l.substr(6)),(p=l.substr(l.lastIndexOf("/")+1))||(p=l),t=p;else if(d.stack)p=c._clones.resolveStack(d.stack).name,l=c.getStackFullName(d.stack),t=c.getItemName(),0===p.indexOf("Nodes/")?t=p.substr(6):0<p.length?t=p:t||(t="header");else continue;a.add((k?"sub:":"header:")+t,l,function(a){return c.activateInBrowser([a],!0)});a.add("Browse",l,function(a){return c.activateInBrowser([a],!0)});c._hpainter&&a.add("Inspect",l,function(a){return c._hpainter.display(a,"inspect")});
d.geo_name?a.add("Hide",e,function(c){c=b[c].object;c.visible=!1;c.geo_object&&(c.geo_object.$hidden_via_menu=!0);a.painter.render3D()}):(d=c.accessObjectWireFrame(d),void 0!==d&&a.addchk(d,"Wireframe",e,function(a){a=b[a].object.material;a.wireframe=!a.wireframe;this.render3D()}),1<++f&&a.add("Manifest",e,function(a){this._last_manifest&&(this._last_manifest.wireframe=!this._last_manifest.wireframe);this._last_hidden&&this._last_hidden.forEach(function(a){a.visible=!0});this._last_hidden=[];for(var c=
0;c<a;++c)this._last_hidden.push(b[c].object);this._last_hidden.forEach(function(a){a.visible=!1});this._last_manifest=b[a].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.render3D()}),a.add("Focus",e,function(a){this.focusCamera(b[a].object)}),c._geom_viewer||a.add("Hide",e,function(c){c=a.painter._clones.resolveStack(b[c].object.stack);c.obj&&0===c.node.kind&&c.obj.fVolume?(g.SetBit(c.obj.fVolume,g.BITS.kVisThis,!1),g.updateBrowserIcons(c.obj.fVolume,this._hpainter)):
c.obj&&1===c.node.kind&&(c.obj.fRnrSelf=!1,g.updateBrowserIcons(c.obj,this._hpainter));this.testGeomChanges()}));k&&a.add("endsub:")}a.show()})};d.prototype.filterIntersects=function(a){if(!a.length)return a;for(var b=0;b<a.length;++b)a[b].object.geo_highlight&&(a[b].object=a[b].object.geo_highlight);for(b=a.length-1;0<=b;--b){var c=a[b].object,e=void 0!==c.stack||void 0!==c.geo_name;e&&c.material&&void 0!==c.material.opacity&&(e=.1<=c.material.opacity);c.jsroot_special&&(e=!1);for(var h=0;h<b&&e;++h)a[h].object===
c&&(e=!1);e||a.splice(b,1)}b=this.ctrl.clip;if(b[0].enabled||b[1].enabled||b[2].enabled){c=[];for(e=0;e<a.length;++e){h=a[e].point;var k="Points"==a[e].object.type,d=!0;b[0].enabled&&this._clipPlanes[0].normal.dot(h)>this._clipPlanes[0].constant^k&&(d=!1);b[1].enabled&&this._clipPlanes[1].normal.dot(h)>this._clipPlanes[1].constant^k&&(d=!1);b[2].enabled&&this._clipPlanes[2].normal.dot(h)>this._clipPlanes[2].constant&&(d=!1);d||c.push(a[e])}a=c}return a};d.prototype.testCameraPositionChange=function(){if(this.ctrl.select_in_view&&
!this._draw_all_nodes){var a=g.createProjectionMatrix(this._camera);g.createFrustum(a).CheckBox(this.getGeomBoundingBox(this._toplevel))||this.startDrawGeometry()}};d.prototype.resolveStack=function(a){return this._clones&&a?this._clones.resolveStack(a):null};d.prototype.getStackFullName=function(a){var b=this.getItemName();return(a=this.resolveStack(a))&&a.name?b?b+"/"+a.name:a.name:b};d.prototype.addHighlightHandler=function(a){a&&"function"==typeof a.highlightMesh&&(this._highlight_handlers||(this._highlight_handlers=
[]),this._highlight_handlers.push(a))};d.prototype.highlightMesh=function(a,b,c,e,h,k){var d=this;if(c){a=a?[a]:[];var m=this.getExtrasContainer();m&&m.traverse(function(b){b.geo_object===c&&0>a.indexOf(b)&&a.push(b)})}else h&&this._toplevel?(a=[],this._toplevel.traverse(function(b){b instanceof f.Mesh&&g.isSameStack(b.stack,h)&&a.push(b)})):a=a?[a]:[];a.length||(a=null);a&&(a[0].geo_object?this.ctrl.highlight_scene||(a=null):this.ctrl.highlight||(a=null));if(!k)for(a&&(c||(c=a[0].geo_object),h||
(h=a[0].stack)),k=this._highlight_handlers||(this._main_painter?this._main_painter._slave_painters.concat([this._main_painter]):this._slave_painters),m=0;m<k.length;++m)k[m]!==this&&k[m].highlightMesh(null,b,c,e,h,!0);m=this._selected_mesh;k=function(a){return a.get_ctrl?a.get_ctrl():new y(a,d.ctrl.bloom.enabled)};if(!m&&!a)return!1;var p=!1;if(m&&a&&m.length==a.length){p=!0;for(var l=0;l<m.length&&p;++l)if(m[l]!==a[l]||k(m[l]).checkHighlightIndex(e))p=!1}if(p)return!!m;if(m)for(p=0;p<m.length;++p)k(m[p]).setHighlight();
if(this._selected_mesh=a)for(m=0;m<a.length;++m)k(a[m]).setHighlight(b||65280,e);this.render3D(0);return!!a};d.prototype.processMouseClick=function(a,b,c){b.length&&(a=b[0].object,a.get_ctrl&&(a=a.get_ctrl(),b=a.extractIndex(b[0]),a.evnt=c,a.setSelected("blue",b)&&this.render3D(),a.evnt=null))};d.prototype.setMouseTmout=function(a){this.ctrl&&(this.ctrl.mouse_tmout=a);this._controls&&(this._controls.mouse_tmout=a)};d.prototype.setDepthMethod=function(a){this.ctrl&&(this.ctrl.depthMethod=a)};d.prototype.addOrbitControls=
function(){if(!this._controls&&this._webgl&&!JSROOT.batch_mode){var a=this;this.setTooltipAllowed(JSROOT.settings.Tooltip);this._controls=n.createOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);this._controls.mouse_tmout=this.ctrl.mouse_tmout;this.ctrl.can_rotate||(this._controls.enableRotate=!1);this._controls.contextMenu=this.orbitContext.bind(this);this._controls.ProcessMouseMove=function(b){if(a.ctrl&&a._controls){for(var c=null,e=null,h=null,k=[],d,f,p=0;p<b.length;++p){var l=
b[p].object,t=null;l&&(l.geo_object?t=l.geo_name:l.stack&&(t=a.getStackFullName(l.stack)),t&&(0==t.indexOf("<prnt>")&&(t=a.getItemName()+t.substr(6)),k.push(t),c||(c=l,e=t,d=l.geo_object,l.get_ctrl&&(f=l.get_ctrl().extractIndex(b[p]),void 0!==f&&"string"==typeof e&&(e+=" indx:"+JSON.stringify(f))),c.stack&&(h=a.resolveStack(c.stack)))))}a.highlightMesh(c,void 0,d,f);a.ctrl.update_browser&&(a.ctrl.highlight&&e&&(k=[e]),a.activateInBrowser(k));if(!h||!h.obj)return e;b=g.provideObjectInfo(h.obj);b.unshift(e);
return{name:h.obj.fName,title:h.obj.fTitle||h.obj._typename,lines:b}}};this._controls.ProcessMouseLeave=function(){this.ProcessMouseMove([])};this._controls.processDblClick=function(){a.ctrl&&a._controls&&(a._last_manifest?(a._last_manifest.wireframe=!a._last_manifest.wireframe,a._last_hidden&&a._last_hidden.forEach(function(a){a.visible=!0}),delete a._last_hidden,delete a._last_manifest,a.render3D()):a.adjustCameraPosition())}}};d.prototype.addTransformControl=function(){var a=this;this._tcontrols||
!this.ctrl._debug&&!this.ctrl._grid||(this._tcontrols=new f.TransformControls(this._camera,this._renderer.domElement),this._scene.add(this._tcontrols),this._tcontrols.attach(this._toplevel),window.addEventListener("keydown",function(b){switch(b.keyCode){case 81:a._tcontrols.setSpace("local"===a._tcontrols.space?"world":"local");break;case 17:a._tcontrols.setTranslationSnap(Math.ceil(a._overall_size)/50);a._tcontrols.setRotationSnap(f.MathUtils.degToRad(15));break;case 84:a._tcontrols.setMode("translate");
break;case 82:a._tcontrols.setMode("rotate");break;case 83:a._tcontrols.setMode("scale");break;case 187:case 107:a._tcontrols.setSize(a._tcontrols.size+.1);break;case 189:case 109:a._tcontrols.setSize(Math.max(a._tcontrols.size-.1,.1))}}),window.addEventListener("keyup",function(a){switch(a.keyCode){case 17:this._tcontrols.setTranslationSnap(null),this._tcontrols.setRotationSnap(null)}}),this._tcontrols.addEventListener("change",function(){return a.render3D(0)}))};d.prototype.nextDrawAction=function(){if(!this._clones||
0==this.drawing_stage)return!1;if(1==this.drawing_stage){if(this._geom_viewer)return this._draw_all_nodes=!1,this.drawing_stage=3,!0;if(0<this.ctrl.use_worker){if(!this._worker)return this.startWorker(),1;if(!this._worker_ready)return 1}var a=this._clones.countVisibles()||this._clones.markVisibles(),b=null,c=null;this.ctrl.select_in_view&&!this._first_drawing&&(b=g.createProjectionMatrix(this._camera),c=g.createFrustum(b),c.CheckBox(this.getGeomBoundingBox(this._toplevel))&&(c=b=null));this._current_face_limit=
this.ctrl.maxlimit;b&&(this._current_face_limit*=1.25);(a=!JSROOT.batch_mode&&(1E4<a||b&&1E5<this._clones.scanVisible()))&&0==JSROOT.source_dir.indexOf("file://")&&(console.log("disable worker for jsroot from file system"),a=!1);a&&!this._worker&&0<=this.ctrl.use_worker&&this.startWorker();if(!a||!this._worker_ready)return b=this._clones.collectVisibles(this._current_face_limit,c),this._new_draw_nodes=b.lst,this._draw_all_nodes=b.complete,this.drawing_stage=3,!0;b={collect:this._current_face_limit,
flags:this._clones.getVisibleFlags(),matrix:b?b.elements:null};this.submitToWorker(b);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(2==this.drawing_stage)return this.drawing_log="Worker select visibles",2;if(3==this.drawing_stage){this.drawing_log="Analyse visibles";if(this._new_append_nodes)this._new_draw_nodes=this._draw_nodes.concat(this._new_append_nodes),delete this._new_append_nodes;else if(this._draw_nodes){b=this._geom_viewer?this._draw_nodes:this._clones.mergeVisibles(this._new_draw_nodes,
this._draw_nodes);for(c=0;c<b.length;++c)this._clones.createObject3D(b[c].stack,this._toplevel,"delete_mesh");0<b.length&&(this.drawing_log="Delete "+b.length+" nodes")}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return!0}if(4===this.drawing_stage)return this.drawing_log="Collect shapes",b=this._clones.collectShapes(this._draw_nodes),this._build_shapes=this._clones.mergeShapesLists(this._build_shapes,b),this.drawing_stage=5,!0;if(5===this.drawing_stage){if(this.canSubmitToWorker()){b=
{limit:this._current_face_limit,shapes:[]};for(a=c=0;a<this._build_shapes.length;++a){var e=this._build_shapes[a];e.ready||e.geom?e={id:e.id,ready:!0,nfaces:g.countGeometryFaces(e.geom),refcnt:e.refcnt}:(e=JSROOT.clone(e,null,!0),c++);b.shapes.push(e)}if(0<c)return this.submitToWorker(b),this.drawing_log="Worker build shapes",this.drawing_stage=6,2}this.drawing_stage=7}if(6===this.drawing_stage)return 2;if(7===this.drawing_stage||8===this.drawing_stage){if(7===this.drawing_stage)if(b=this._clones.buildShapes(this._build_shapes,
this._current_face_limit,500),b.done)this.ctrl.info.num_shapes=this._build_shapes.length,this.drawing_stage=8;else if(this.ctrl.info.num_shapes=b.shapes,this.drawing_log="Creating: "+b.shapes+" / "+this._build_shapes.length+" shapes,  "+b.faces+" faces",30>b.notusedshapes)return!0;b=(new Date).getTime();c=!0;a=this.ctrl.project?this._full_geom:this._toplevel;for(e=0;e<this._draw_nodes.length;++e){var h=this._draw_nodes[e];if(!h.done){var k=h.server_shape||this._build_shapes[h.shapeid];if(k.ready){if(h.done=
!0,k.used=!0,this.createEntryMesh(h,k,a)&&(this.ctrl.info.num_meshes++,this.ctrl.info.num_faces+=k.nfaces),500<(new Date).getTime()-b){c=!1;break}}else 8===this.drawing_stage&&console.warn("shape marked as not ready when should"),c=!1}}if(c){if(this.ctrl.project)return this.drawing_log="Build projection",this.drawing_stage=10,!0;this.drawing_log="Building done";this.drawing_stage=0;return!1}7<this.drawing_stage&&(this.drawing_log="Building meshes "+this.ctrl.info.num_meshes+" / "+this.ctrl.info.num_faces);
return!0}if(9===this.drawing_stage){if(!this._main_painter)return console.warn("MAIN PAINTER DISAPPER"),this.drawing_stage=0,!1;if(!this._main_painter._drawing_ready)return 1;this.drawing_stage=10}if(10===this.drawing_stage)return this.doProjection(),this.drawing_log="Building done",this.drawing_stage=0,!1;console.error("never come here stage = "+this.drawing_stage);return!1};d.prototype.createEntryMesh=function(a,b,c){if(!b.geom||0===b.nfaces)return this._clones.createObject3D(a.stack,c,"delete_mesh"),
!1;this._splitColors&&a.stack&&(0===a.stack[0]?a.custom_color="green":1===a.stack[0]&&(a.custom_color="blue"));var e=this._clones.getDrawEntryProperties(a);c=this._clones.createObject3D(a.stack,c,this.ctrl);e.material.wireframe=this.ctrl.wireframe;e.material.side=this.ctrl.bothSides?f.DoubleSide:f.FrontSide;b=-.9<(c.absMatrix||c.matrixWorld).determinant()?new f.Mesh(b.geom,e.material):g.createFlippedMesh(b,e.material);c.add(b);c.absMatrix&&(b.matrix.copy(c.absMatrix),b.matrix.decompose(b.position,
b.quaternion,b.scale),b.updateMatrixWorld());b.stack=a.stack;b.renderOrder=this._clones.maxdepth-a.stack.length;b.$jsroot_order=c.$jsroot_depth;if(this.ctrl._debug||this.ctrl._full)a=new f.WireframeGeometry(b.geometry),e=new f.LineBasicMaterial({color:e.fillcolor,linewidth:e.linewidth||1}),e=new f.LineSegments(a,e),c.add(e);if(this.ctrl._bound||this.ctrl._full)b=new f.BoxHelper(b),c.add(b);return!0};d.prototype.appendMoreNodes=function(a,b){if(this.drawing_stage&&!b)this._provided_more_nodes=a;else{if(this._more_nodes)for(var c=
0;c<this._more_nodes.length;++c){var e=this._more_nodes[c],h=this._clones.createObject3D(e.stack,this._toplevel,"delete_mesh");n.disposeThreejsObject(h);g.cleanupShape(e.server_shape);delete e.server_shape}delete this._more_nodes;if(a){c=[];for(e=0;e<a.length;++e){h=a[e];var k=h.server_shape;k&&k.ready&&(h.done=!0,k.used=!0,this.createEntryMesh(h,k,this._toplevel)&&c.push(h))}0<c.length&&(this._more_nodes=c);b||this.render3D()}}};d.prototype.getProjectionSource=function(){return this._clones_owner?
this._full_geom:this._main_painter?this._main_painter._drawing_ready?this._main_painter._toplevel:(console.warn("MAIN PAINTER NOT READY WHEN DO PROJECTION"),null):(console.warn("MAIN PAINTER DISAPPER"),null)};d.prototype.getGeomBoundingBox=function(a,b){var c=new f.Box3,e=!this._clones;if(!a)return c.min.x=c.min.y=c.min.z=-1,c.max.x=c.max.y=c.max.z=1,c;c.makeEmpty();a.traverse(function(a){(e||a.stack&&a instanceof f.Mesh||a.main_track&&a instanceof f.LineSegments)&&g.getBoundingBox(a,c)});void 0!==
b&&c.expandByVector(c.getSize(new f.Vector3).multiplyScalar(b));return c};d.prototype.doProjection=function(){var a=this,b=this.getProjectionSource();if(!b)return!1;n.disposeThreejsObject(this._toplevel,!0);if(void 0===this.ctrl.projectPos){var c=this.getGeomBoundingBox(b),e=c.min[this.ctrl.project];c=c.max[this.ctrl.project];var h=(e+c)/2;0>e&&0<c&&Math.abs(h)<.2*Math.max(-e,c)&&(h=0);this.ctrl.projectPos=h}b.traverse(function(b){if(b instanceof f.Mesh&&b.stack){var c=g.projectGeometry(b.geometry,
b.parent.absMatrix||b.parent.matrixWorld,a.ctrl.project,a.ctrl.projectPos,b._flippedMesh);c&&(c=new f.Mesh(c,b.material.clone()),a._toplevel.add(c),c.stack=b.stack)}});return!0};d.prototype.changedLight=function(a){if(this._camera){var b=!a;a||(a=this.getGeomBoundingBox(this._toplevel));var c=a.max.x-a.min.x,e=a.max.y-a.min.y;a=a.max.z-a.min.z;var h=[],k=this.ctrl.light.power;void 0===k&&(k=1);if(this._camera._lights!=this.ctrl.light.kind)switch(n.disposeThreejsObject(this._camera,!0),this._camera._lights=
this.ctrl.light.kind,this._camera._lights){case "ambient":this._camera.add(new f.AmbientLight(15724527,k));break;case "hemisphere":this._camera.add(new f.HemisphereLight(16777147,526368,k));break;default:for(var d=0;6>d;++d)this._camera.add(new f.PointLight(15724527,k))}for(d=0;d<this._camera.children.length;++d){var g=this._camera.children[d],p=!1;if(g.isAmbientLight||g.isHemisphereLight)g.intensity=k;else if(g.isPointLight){switch(d){case 0:g.position.set(c/5,e/5,a/5);p=this.ctrl.light.specular;
break;case 1:g.position.set(0,0,a/2);p=this.ctrl.light.front;break;case 2:g.position.set(0,2*e,0);p=this.ctrl.light.top;break;case 3:g.position.set(0,-2*e,0);p=this.ctrl.light.bottom;break;case 4:g.position.set(-2*c,0,0);p=this.ctrl.light.left;break;case 5:g.position.set(2*c,0,0),p=this.ctrl.light.right}g.power=p?k*Math.PI*4:0;p&&h.push(g)}}h.forEach(function(a){a.power=4*k*Math.PI/h.length});b&&this.render3D()}};d.prototype.createCamera=function(){this._camera&&(this._scene.remove(this._camera),
n.disposeThreejsObject(this._camera),delete this._camera);this.ctrl.ortho_camera?this._camera=new f.OrthographicCamera(-this._scene_width/2,this._scene_width/2,this._scene_height/2,-this._scene_height/2,1,1E4):(this._camera=new f.PerspectiveCamera(25,this._scene_width/this._scene_height,1,1E4),this._camera.up=this.ctrl._yup?new f.Vector3(0,1,0):new f.Vector3(0,0,1));var a=new f.PointLight(15724527,1);a.position.set(10,10,10);this._camera.add(a);this._scene.add(this._camera)};d.prototype.createSpecialEffects=
function(){this._webgl&&(this.ctrl.ssao.enabled||this.ctrl.outline)&&(this.ctrl.outline&&"function"==typeof this.createOutline?(this._effectComposer=new f.EffectComposer(this._renderer),this._effectComposer.addPass(new f.RenderPass(this._scene,this._camera)),this.createOutline(this._scene_width,this._scene_height)):this.ctrl.ssao.enabled&&this.createSSAO());this._webgl&&this.ctrl.bloom.enabled&&this.createBloom()};d.prototype.createScene=function(a,b){this._scene=new f.Scene;this._scene.fog=new f.Fog(16777215,
1,1E4);this._scene.overrideMaterial=new f.MeshLambertMaterial({color:7340287,transparent:!0,opacity:.2,depthTest:!1});this._scene_width=a;this._scene_height=b;this.createCamera();this._selected_mesh=null;this._overall_size=10;this._toplevel=new f.Object3D;this._scene.add(this._toplevel);this._renderer=n.createRender3D(a,b,this.options.Render3D,{antialias:!0,logarithmicDepthBuffer:!1,preserveDrawingBuffer:!0});this._webgl=this._renderer.jsroot_render3d===JSROOT.constants.Render3D.WebGL;this._renderer.setPixelRatio&&
!JSROOT.nodejs&&this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(a,b,!this._fit_main_area);this._renderer.localClippingEnabled=!0;this._renderer.setClearColor(this.ctrl.background,1);if(this._fit_main_area&&this._webgl){this._renderer.domElement.style.width="100%";this._renderer.domElement.style.height="100%";var c=this.selectDom();"static"==c.style("position")&&c.style("position","relative")}this._animating=!1;this.ctrl.bothSides=!1;this._clipPlanes=[new f.Plane(new f.Vector3(1,
0,0),0),new f.Plane(new f.Vector3(0,this.ctrl._yup?-1:1,0),0),new f.Plane(new f.Vector3(0,0,this.ctrl._yup?1:-1),0)];this.createSpecialEffects();return this._fit_main_area&&!this._webgl?(c=JSROOT._.get_document().createElementNS("http://www.w3.org/2000/svg","svg"),r.select(c).attr("width",a).attr("height",b),c.appendChild(this._renderer.jsroot_dom),c):this._renderer.jsroot_dom};d.prototype.startDrawGeometry=function(a){a||0===this.drawing_stage?(this._clones_owner&&this._clones&&this._clones.setDefaultColors(this.ctrl.dflt_colors),
this._last_render_tm=this._startm=(new Date).getTime(),this._last_render_meshes=0,this.drawing_stage=1,this._drawing_ready=!1,this.drawing_log="collect visible",this.ctrl.info.num_meshes=0,this.ctrl.info.num_faces=0,this.ctrl.info.num_shapes=0,this._selected_mesh=null,this.ctrl.project&&(this._clones_owner?this._full_geom?(this.drawing_stage=10,this.drawing_log="build projection"):this._full_geom=new f.Object3D:(this.drawing_stage=9,this.drawing_log="wait for main painter")),delete this._last_manifest,
delete this._last_hidden,delete this._draw_nodes_again,this.continueDraw()):this._draw_nodes_again=!0};d.prototype.resetAdvanced=function(){this.ctrl.ssao.kernelRadius=16;this.ctrl.ssao.output=f.SSAOPass.OUTPUT.Default;this.ctrl.depthTest=!0;this.ctrl.clipIntersect=!0;this.ctrl.depthMethod="ray";this.changedDepthMethod("norender");this.changedDepthTest()};d.prototype.getOverallSize=function(a){if(!this._overall_size||a){a=this.getGeomBoundingBox(this._toplevel);if(!Number.isFinite(a.min.x))return 1E3;
this._overall_size=2*Math.max(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z)}return this._overall_size};d.prototype.createSnapshot=function(a){if(this._renderer){this.render3D(0);var b=this._renderer.domElement.toDataURL("image/png");if("asis"===a)return b;b.replace("image/png","image/octet-stream");var c=JSROOT._.get_document(),e=c.createElement("a");"string"===typeof e.download&&(c.body.appendChild(e),e.download=a||"geometry.png",e.href=b,e.click(),c.body.removeChild(e))}};d.prototype.produceCameraUrl=
function(a){if(this._lookat&&this._camera0pos&&this._camera&&this.ctrl){var b=(new f.Vector3).add(this._camera0pos).sub(this._lookat),c=(new f.Vector3).add(this._camera.position).sub(this._lookat),e=b.length(),h=c.length();e=this.ctrl.zoom*h/e*100;1>e?e=1:1E4<e&&(e=1E4);b.normalize();c.normalize();h=new f.Quaternion;h.setFromUnitVectors(b,c);b=new f.Euler;b.setFromQuaternion(h,"YZX");c=b.y/Math.PI*180;b=b.z/Math.PI*180;0>c&&(c+=360);0>b&&(b+=360);return"roty"+c.toFixed(a||0)+",rotz"+b.toFixed(a||
0)+",zoom"+e.toFixed(a||0)}};d.prototype.calculateZoom=function(){if(this._camera0pos&&this._camera&&this._lookat){var a=(new f.Vector3).add(this._camera0pos).sub(this._lookat);return(new f.Vector3).add(this._camera.position).sub(this._lookat).length()/a.length()}return 0};d.prototype.adjustCameraPosition=function(a,b){if(this._toplevel){var c=this.getGeomBoundingBox(this._toplevel);if(Number.isFinite(c.min.x)){var e=c.max.x-c.min.x,h=c.max.y-c.min.y,k=c.max.z-c.min.z,d=(c.max.x+c.min.x)/2,g=(c.max.y+
c.min.y)/2,p=(c.max.z+c.min.z)/2;this._overall_size=2*Math.max(e,h,k);this._camera.near=this._overall_size/350;this._camera.far=12*this._overall_size;this._scene.fog.near=2*this._overall_size;this._scene.fog.far=12*this._overall_size;if(a)for(a=0;3>a;++a){var l=this.ctrl.clip[a];l.min=c.min[l.name];l.max=c.max[l.name];var t=l.max-l.min;l.max+=.01*t;l.min-=.01*t;l.value?l.value<l.min?l.value=l.min:l.value>l.max&&(l.value=l.max):l.value=(l.min+l.max)/2}this.ctrl.ortho_camera&&(this._camera.left=c.min.x,
this._camera.right=c.max.x,this._camera.top=c.max.y,this._camera.bottom=c.min.y);this._camera.updateProjectionMatrix();a=2*this.ctrl.zoom;l=Math.max(e,h,k);if((this.ctrl.rotatey||this.ctrl.rotatez)&&this.ctrl.can_rotate)e=this.calculateZoom(),b&&e&&(a=2*e),h=new f.Euler(0,this.ctrl.rotatey/180*Math.PI,this.ctrl.rotatez/180*Math.PI,"YZX"),this._camera.position.set(-a*l,0,0),this._camera.position.applyEuler(h),this._camera.position.add(new f.Vector3(d,g,p)),b&&e&&(b=this.calculateZoom(),this._camera.position.set(-(e/
b*a)*l,0,0),this._camera.position.applyEuler(h),this._camera.position.add(new f.Vector3(d,g,p)));else if(this.ctrl.ortho_camera)this._camera.position.set(d,g,Math.max(e,h));else if(this.ctrl.project)switch(this.ctrl.project){case "x":this._camera.position.set(1.5*a*Math.max(h,k),0,0);break;case "y":this._camera.position.set(0,1.5*a*Math.max(e,k),0);break;case "z":this._camera.position.set(0,0,1.5*a*Math.max(e,h))}else this.ctrl._yup?this._camera.position.set(d-a*Math.max(e,k),g+a*h,p-a*Math.max(e,
k)):this._camera.position.set(d-a*Math.max(e,h),g-a*Math.max(e,h),p+a*k);this._lookat=new f.Vector3(d,g,p);this._camera0pos=new f.Vector3(-2*l,0,0);this._camera.lookAt(this._lookat);this.changedLight(c);this._controls&&(this._controls.target.copy(this._lookat),this._controls.update());this.ctrl.select_in_view&&this.startDrawGeometry()}}};d.prototype.setCameraPosition=function(a,b,c){this.ctrl&&(this.ctrl.rotatey=a||0,this.ctrl.rotatez=b||0,a=!1,c&&Number.isFinite(c)?this.ctrl.zoom=c:a=!0,this.adjustCameraPosition(!1,
a))};d.prototype.focusOnItem=function(a){a&&this._clones&&(a=this._clones.findStackByName(a))&&(a=this._clones.resolveStack(a,!0),this.focusCamera(a,!1))};d.prototype.focusCamera=function(a,b){var c=this;if(this.ctrl.project||this.ctrl.ortho_camera)return this.adjustCameraPosition();var e=new f.Box3;if(void 0===a)e=this.getGeomBoundingBox(this._toplevel);else if(a instanceof f.Mesh)e.setFromObject(a);else{var h=(new f.Vector3).setFromMatrixPosition(a.matrix);a=a.node;a=(new f.Vector3(a.fDX,a.fDY,
a.fDZ)).multiplyScalar(.5);e.min=h.clone().sub(a);e.max=h.clone().add(a)}var k=e.max.x-e.min.x,d=e.max.y-e.min.y,g=e.max.z-e.min.z;h=(e.max.x+e.min.x)/2;a=(e.max.y+e.min.y)/2;e=(e.max.z+e.min.z)/2;k=this.ctrl._yup?new f.Vector3(h-2*Math.max(k,g),a+2*d,e-2*Math.max(k,g)):new f.Vector3(h-2*Math.max(k,d),a-2*Math.max(k,d),e+2*g);e=new f.Vector3(h,a,e);var p=this._controls.target,l=50,t=0,n=k.sub(this._camera.position).divideScalar(l),r=e.sub(p).divideScalar(l);if(b=b&&this._webgl){for(e=0;3>e;++e)h=
this.ctrl.clip[e],h.enabled||(h.value=h.min,h.enabled=!0),h.inc=((h.min+h.max)/2-h.value)/l;this.updateClipping()}this._animating=!0;var u=function(){if(void 0!==c._animating){c._animating?requestAnimationFrame(u):c._geom_viewer||c.startDrawGeometry();var a=-Math.cos(2*Math.PI*t/l)+1;c._camera.position.add(n.clone().multiplyScalar(a));p.add(r.clone().multiplyScalar(a));c._lookat=p;c._camera.lookAt(c._lookat);c._camera.updateProjectionMatrix();var e=(new Date).getTime();if(b){for(var h=0;3>h;++h)c.ctrl.clip[h].value+=
c.ctrl.clip[h].inc*a;c.updateClipping()}else c.render3D(0);a=(new Date).getTime();0==t&&200<a-e&&(l=20);t++;c._animating=t<l}};u()};d.prototype.autorotate=function(a){var b=this,c=void 0===a?2:a,e=new Date,h=function(){if(b._renderer&&b.ctrl){var a=new Date;b.ctrl.rotate&&requestAnimationFrame(h);b._controls&&(b._controls.autoRotate=b.ctrl.rotate,b._controls.autoRotateSpeed=c*(a.getTime()-e.getTime())/16.6666,b._controls.update());e=new Date;b.render3D(0)}};this._webgl&&h()};d.prototype.completeScene=
function(){if(this.ctrl._debug||this.ctrl._grid){if(this.ctrl._full){var a=new f.BoxHelper(this._toplevel);this._scene.add(a)}this._scene.add(new f.AxesHelper(2*this._overall_size));this._scene.add(new f.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};
d.prototype.drawCount=function(a,b){function c(a){return JSROOT.batch_mode?"anytime ms":a.toString()+" ms"}var e=this,h=["Unique nodes: "+this._clones.nodes.length,"Unique visible: "+a,"Time to clone: "+c(b)];this._clones.scanVisible();var k=0,d={clones:this._clones,cnt:[],func:function(a){void 0===this.cnt[this.last]?this.cnt[this.last]=1:this.cnt[this.last]++;k+=g.countNumShapes(this.clones.getNodeShape(a.id));return!0}},f=(new Date).getTime(),p=this._clones.scanVisible(d),l=(new Date).getTime();
h.push("Total visible nodes: "+p,"Total shapes: "+k);for(a=0;a<d.cnt.length;++a)void 0!==d.cnt[a]&&h.push("  lvl"+a+": "+d.cnt[a]);h.push("Time to scan: "+c(l-f),"","Check timing for matrix calculations ...");var t=this.selectDom().style("overflow","auto");JSROOT.batch_mode?t.property("_json_object_",h):h.forEach(function(a){return t.append("p").text(a)});return new Promise(function(a){setTimeout(function(){d.domatrix=!0;f=(new Date).getTime();p=e._clones.scanVisible(d);l=(new Date).getTime();var b=
"Time to scan with matrix: "+c(l-f);JSROOT.batch_mode?h.push(b):t.append("p").text(b);a(e)},100)})};d.prototype.performDrop=function(a,b,c,e){var h=this;if(a&&"TTree"===a.$kind){b="extract_geo_tracks";e&&0<e.indexOf("$")&&(b=e.substr(0,e.indexOf("$")),e=e.substr(e.indexOf("$")+1));var k=JSROOT.findFunction(b);return k?k(a,e).then(function(a){return a?h.drawExtras(a,"",!1).then(function(){h.updateClipping(!0);return h.render3D(100)}):h}):Promise.reject(Error("Function "+b+" not found"))}return this.drawExtras(a,
b).then(function(a){if(!a)return h;c&&(c._painter=h);return h.render3D(100)})};d.prototype.mouseOverHierarchy=function(a,b,c){this.ctrl&&(c=c._obj,this.ctrl._debug&&console.log("Mouse over",a,b,c?c._typename:"---"),!c||"TEveTrack"!==c._typename&&"TEvePointSet"!==c._typename&&"TPolyMarker3D"!==c._typename||this.highlightMesh(null,65280,a?c:null))};d.prototype.clearExtras=function(){this.getExtrasContainer("delete");delete this._extraObjects;this.render3D()};d.prototype.addExtra=function(a,b){void 0===
this._extraObjects&&(this._extraObjects=JSROOT.create("TList"));if(0<=this._extraObjects.arr.indexOf(a))return!1;this._extraObjects.Add(a,b);delete a.$hidden_via_menu;return!0};d.prototype.extraObjectVisible=function(a,b,c){var e=this;if(this._extraObjects){a=a.itemFullName(b);var h=this._extraObjects.opt.indexOf(a);0>h&&b._obj&&(h=this._extraObjects.arr.indexOf(b._obj),0<=h&&(this._extraObjects.opt[h]=a));if(!(0>h)){var k=this._extraObjects.arr[h];b=k.$hidden_via_menu?!1:!0;if(c){k.$hidden_via_menu=
b;b=!b;var d=null;this._toplevel.traverse(function(a){a.geo_object===k&&(d=a)});d?(d.visible=b,this.render3D()):b&&this.drawExtras(k,"",!1).then(function(){e.updateClipping(!0);e.render3D()})}return b}}};d.prototype.drawExtras=function(a,b,c){var e=this;if(!a||!a._typename||!c&&a.$hidden_via_menu)return Promise.resolve(!1);var h=!1;void 0===c&&(h=c=!0);var d=!1;if("TList"===a._typename||"TObjArray"===a._typename){if(!a.arr)return!1;d=[];for(var f=0;f<a.arr.length;++f){var g=a.arr[f],p=a.opt?a.opt[f]:
"";p||(p=(b||"<prnt>")+"/["+f+"]");d.push(this.drawExtras(g,p,c))}d=Promise.all(d).then(function(a){return 0<=a.indexOf(!0)})}else if("THREE.Mesh"===a._typename)this.addToExtrasContainer(a),d=Promise.resolve(!0),is_any=!0;else if("TGeoTrack"===a._typename){if(!c||this.addExtra(a,b))d=this.drawGeoTrack(a,b)}else if("TPolyLine3D"===a._typename){if(!c||this.addExtra(a,b))d=this.drawPolyLine(a,b)}else if("TEveTrack"===a._typename||"ROOT::Experimental::TEveTrack"===a._typename){if(!c||this.addExtra(a,
b))d=this.drawEveTrack(a,b)}else if("TEvePointSet"===a._typename||"ROOT::Experimental::TEvePointSet"===a._typename||"TPolyMarker3D"===a._typename){if(!c||this.addExtra(a,b))d=this.drawHit(a,b)}else if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename)if(!c||this.addExtra(a,b))d=this.drawExtraShape(a,b);n.isPromise(d)||(d=Promise.resolve(d));return h?d.then(function(a){if(!a)return!1;e.updateClipping(!0);return e.render3D(100)}):d};d.prototype.getExtrasContainer=
function(a,b){if(!this._toplevel)return null;b||(b="tracks");for(var c=null,e=[],h=0;h<this._toplevel.children.length;++h){var d=this._toplevel.children[h];if(d._extras)if("collect"===a)e.push(d);else if(d._extras===b){c=d;break}}if("collect"===a){for(a=0;a<e.length;++a)this._toplevel.remove(e[a]);return e}if("delete"===a)return c&&this._toplevel.remove(c),n.disposeThreejsObject(c),null;"get"===a||c||(c=new f.Object3D,c._extras=b,this._toplevel.add(c));return c};d.prototype.addToExtrasContainer=function(a,
b){(b=this.getExtrasContainer("",b))?b.add(a):(console.warn("Fail to add object to extras"),n.disposeThreejsObject(a))};d.prototype.drawGeoTrack=function(a,b){if(!a||!a.fNpoints)return!1;var c=a.fLineWidth||1,e=n.getColor(a.fLineColor)||"rgb(255,0,255)";JSROOT.browser.isWin&&(c=1);for(var h=Math.round(a.fNpoints/4),d=new Float32Array(6*(h-1)),g=0,m=this.ctrl.projectPos,p="x"===this.ctrl.project,l="y"===this.ctrl.project,t="z"===this.ctrl.project,z=0;z<h-1;++z)d[g]=p?m:a.fPoints[4*z],d[g+1]=l?m:a.fPoints[4*
z+1],d[g+2]=t?m:a.fPoints[4*z+2],d[g+3]=p?m:a.fPoints[4*z+4],d[g+4]=l?m:a.fPoints[4*z+5],d[g+5]=t?m:a.fPoints[4*z+6],g+=6;c=new f.LineBasicMaterial({color:e,linewidth:c});d=n.createLineSegments(d,c);d.renderOrder=1E6;d.geo_name=b;d.geo_object=a;d.hightlightWidthScale=2;b&&0==b.indexOf("<prnt>/Tracks")&&(d.main_track=!0);this.addToExtrasContainer(d);return!0};d.prototype.drawPolyLine=function(a,b){if(!a)return!1;var c=a.fLineWidth||1,e=n.getColor(a.fLineColor)||"#ff00ff";JSROOT.browser.isWin&&(c=1);
if(a._blob&&4==a._blob.length){var d=a._blob[1];var k=a._blob[2]}else d=a.fN,k=a.fP;var g=d;d=new Float32Array(6*(g-1));for(var m=0,p=this.ctrl.projectPos,l="x"===this.ctrl.project,t="y"===this.ctrl.project,z="z"===this.ctrl.project,r=0;r<g-1;++r)d[m]=l?p:k[3*r],d[m+1]=t?p:k[3*r+1],d[m+2]=z?p:k[3*r+2],d[m+3]=l?p:k[3*r+3],d[m+4]=t?p:k[3*r+4],d[m+5]=z?p:k[3*r+5],m+=6;c=new f.LineBasicMaterial({color:e,linewidth:c});c=n.createLineSegments(d,c);c.renderOrder=1E6;c.geo_name=b;c.geo_object=a;c.hightlightWidthScale=
2;this.addToExtrasContainer(c);return!0};d.prototype.drawEveTrack=function(a,b){if(!a||0>=a.fN)return!1;var c=a.fLineWidth||1,e=n.getColor(a.fLineColor)||"rgb(255,0,255)";JSROOT.browser.isWin&&(c=1);for(var d=new Float32Array(6*(a.fN-1)),k=0,g=this.ctrl.projectPos,m="x"===this.ctrl.project,p="y"===this.ctrl.project,l="z"===this.ctrl.project,t=0;t<a.fN-1;++t)d[k]=m?g:a.fP[3*t],d[k+1]=p?g:a.fP[3*t+1],d[k+2]=l?g:a.fP[3*t+2],d[k+3]=m?g:a.fP[3*t+3],d[k+4]=p?g:a.fP[3*t+4],d[k+5]=l?g:a.fP[3*t+5],k+=6;c=
new f.LineBasicMaterial({color:e,linewidth:c});d=n.createLineSegments(d,c);d.renderOrder=1E6;d.geo_name=b;d.geo_object=a;d.hightlightWidthScale=2;this.addToExtrasContainer(d);return!0};d.prototype.drawHit=function(a,b){var c=this;if(!a||!a.fN||0>a.fN)return!1;var e=a.fMarkerSize*this.getOverallSize()*.005;.2>=e&&(e=.2);var d=a.fMarkerStyle;if(4==d||2==d)d=7,e*=1.5;var f=a.fN,g=this.ctrl.projectPos,m="x"===this.ctrl.project,p="y"===this.ctrl.project,l="z"===this.ctrl.project;e=new n.PointsCreator(f,
this._webgl,e);for(var t=0;t<f;t++)e.addPoint(m?g:a.fP[3*t],p?g:a.fP[3*t+1],l?g:a.fP[3*t+2]);return e.createPoints({color:n.getColor(a.fMarkerColor)||"rgb(0,0,255)",style:d,promise:!0}).then(function(e){e.renderOrder=1E6;e.highlightScale=2;e.geo_name=b;e.geo_object=a;c.addToExtrasContainer(e);return!0})};d.prototype.drawExtraShape=function(a,b){var c=g.build(a);if(!c)return!1;c.geo_name=b;c.geo_object=a;this.addToExtrasContainer(c);return!0};d.prototype.findNodeWithVolume=function(a,b,c,e,d){var h=
!1,f=null;if(c)0<e.length&&(e+="/"),e+=c.fName;else{c=this.getGeometry();if(!c&&0!==g.getNodeKind(c))return null;e=this.geo_manager?c.fName:"";h=!0;d=[]}if(!c.fVolume||c.fVolume._searched)return null;if(a.test(c.fVolume.fName)&&(f=b({node:c,item:e})))return f;c.fVolume._searched=!0;d.push(c.fVolume);if(c.fVolume.fNodes)for(var m=0;m<c.fVolume.fNodes.arr.length&&!(f=this.findNodeWithVolume(a,b,c.fVolume.fNodes.arr[m],e,d));++m);if(h)for(a=0,b=d.length;a<b;++a)delete d[a]._searched;return f};d.prototype.loadMacro=
function(a){var b={obj:this.getGeometry(),prefix:""};this.geo_manager&&(b.prefix=b.obj.fName);if(!a||3>a.length||0!==g.getNodeKind(b.obj))return Promise.resolve(b);var c=this,e={GetVolume:function(a){var e=c.findNodeWithVolume(new RegExp("^"+a+"$"),function(a){return a});e||console.log("Did not found "+a+" volume");return{found:e,fVolume:e?e.node.fVolume:null,InvisibleAll:function(a){g.setInvisibleAll(this.fVolume,a)},Draw:function(){this.found&&this.fVolume&&(b.obj=this.found.node,b.prefix=this.found.item,
console.log("Select volume for drawing",this.fVolume.fName,b.prefix))},SetTransparency:function(a){this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial&&(this.fVolume.fMedium.fMaterial.fFillStyle=3E3+a)},SetLineColor:function(a){this.fVolume&&(this.fVolume.fLineColor=a)}}},DefaultColors:function(){c.ctrl.dflt_colors=!0},SetMaxVisNodes:function(a){c.ctrl.maxnodes||(c.ctrl.maxnodes=pasrseInt(a)||0)},SetVisLevel:function(a){c.ctrl.vislevel||(c.ctrl.vislevel=parseInt(a)||0)}};n.showProgress("Loading macro "+
a);return JSROOT.httpRequest(a,"text").then(function(a){a=a.split("\n");for(var c=0;c<a.length;){var d=a[c++].trim();if(!(0==d.indexOf("//")||0>d.indexOf("gGeoManager")||(d=d.replace("->GetVolume",".GetVolume"),d=d.replace("->InvisibleAll",".InvisibleAll"),d=d.replace("->SetMaxVisNodes",".SetMaxVisNodes"),d=d.replace("->DefaultColors",".DefaultColors"),d=d.replace("->Draw",".Draw"),d=d.replace("->SetTransparency",".SetTransparency"),d=d.replace("->SetLineColor",".SetLineColor"),d=d.replace("->SetVisLevel",
".SetVisLevel"),0<=d.indexOf("->"))))try{(new Function("gGeoManager",d))(e)}catch(m){console.error("Problem by processing "+d)}}return b}).catch(function(){console.error("Fail to load "+a);return b})};d.prototype.assignClones=function(a){this._clones_owner=!0;this._clones=a};d.prototype.prepareObjectDraw=function(a,b){var c=this;if(this.did_cleanup)return Promise.resolve(null);if("__geom_viewer_append__"==b)this._new_append_nodes=a,this.ctrl.use_worker=0,this._geom_viewer=!0;else if("__geom_viewer_selection__"==
b&&this._clones)this._new_draw_nodes=a,this.ctrl.use_worker=0,this._geom_viewer=!0;else if(this._main_painter)this._clones_owner=!1,this._clones=this._main_painter._clones,console.log("Reuse clones",this._clones.nodes.length,"from main painter");else if(a){this._start_drawing_time=(new Date).getTime();this._clones_owner=!0;this._clones=new g.ClonedNodes(a);a=this.ctrl.vislevel;var e=this.ctrl.maxnodes;this.geo_manager&&(!a&&this.geo_manager.fVisLevel&&(a=this.geo_manager.fVisLevel),e||(e=this.geo_manager.fMaxVisNodes));
this._clones.setVisLevel(a);this._clones.setMaxVisNodes(e);this._clones.name_prefix=b;a=!!this.geo_manager&&!this.ctrl.showtop;b=this.ctrl.no_screen?0:this._clones.markVisibles(!0,!1,a);b=0>=b?this._clones.markVisibles(!1,!1,a):this._clones.markVisibles(!0,!0,a);this._clones.produceIdShifts();a=(new Date).getTime()-this._start_drawing_time;this._scene||console.log("Creating clones",this._clones.nodes.length,"takes",a,"uniquevis",b);if(this.options._count)return this.drawCount(b,a)}else this._clones_owner=
!1,this._clones=null;b=Promise.resolve(!0);this._scene||(this.ctrl.maxlimit=(this._webgl?2E5:1E5)*this.ctrl.more,this._first_drawing=!0,(this._on_pad=!!this.getPadPainter())?b=n.ensureTCanvas(this,"3d").then(function(){var a=c.getFramePainter(),b=n.getRender3DKind();n.assign3DHandler(a);a.mode3d=!0;var e=a.getSizeFor3d(void 0,b);c._fit_main_area=-1===e.can3d;var d=c.createScene(e.width,e.height);a.add3dCanvas(e,d,b===JSROOT.constants.Render3D.WebGL)}):(0<this.ctrl.use_worker&&this.startWorker(),n.assign3DHandler(this),
a=this.getSizeFor3d(this._webgl?void 0:3),this._fit_main_area=-1===a.can3d,e=this.createScene(a.width,a.height),this.add3dCanvas(a,e,this._webgl)));return b.then(function(){c.setAsMainPainter();c.createToolbar();if(c._clones)return new Promise(function(a){c._resolveFunc=a;c.showDrawInfo("Drawing geometry");c.startDrawGeometry(!0)});c.completeDraw();return c})};d.prototype.showDrawInfo=function(a){if(this._first_drawing&&this._start_drawing_time){var b=this._renderer.domElement.parentNode,c=r.select(b).select(".geo_info");
if(a){var e=.001*((new Date).getTime()-this._start_drawing_time);c.empty()&&(c=r.select(b).append("p").attr("class","geo_info"));c.html(a+", "+e.toFixed(1)+"s")}else c.remove()}};d.prototype.continueDraw=function(){var a=this;if(0!==this.drawing_stage){for(var b=(new Date).getTime(),c=this._first_drawing?1E3:200,e=b;;){var d=this.nextDrawAction();if(!d)break;e=(new Date).getTime();if(1E5<e-this._startm){this.drawing_stage=0;break}if(!(!0===d&&e-b<c)&&(e-b>c||1===d||2===d)){n.showProgress(this.drawing_log);
this.showDrawInfo(this.drawing_log);this._first_drawing&&this._webgl&&100<this._num_meshes-this._last_render_meshes&&e-this._last_render_tm>2.5*c&&(this.adjustCameraPosition(),this.render3D(-1),this._last_render_meshes=this.ctrl.info.num_meshes);2!==d&&setTimeout(function(){return a.continueDraw()},1===d?100:1);return}}b=e-this._startm;(this._first_drawing||this._full_redrawing)&&console.log("Create tm = "+b+" meshes "+this.ctrl.info.num_meshes+" faces "+this.ctrl.info.num_faces);if(300<b)return n.showProgress("Rendering geometry"),
this.showDrawInfo("Rendering"),setTimeout(function(){return a.completeDraw(!0)},10);this.completeDraw(!0)}};d.prototype.testCameraPosition=function(a){this._camera.updateMatrixWorld();var b=this._camera.position.clone();!a&&this._last_camera_position&&this._last_camera_position.distanceTo(b)<1E-4*(this._overall_size||1E3)||(this._last_camera_position=b,!this.ctrl.project&&this._webgl&&g.produceRenderOrder(this._toplevel,b,this.ctrl.depthMethod,this._clones))};d.prototype.render3D=function(a,b){var c=
this;if(!this._renderer)return this.did_cleanup?console.warn("try to render after cleanup"):console.warn("renderer object not exists - check code"),this;var e=void 0!==a&&0<a;void 0===a&&(a=5);if(0<a&&this._webgl){JSROOT.batch_mode&&(a=1);if(e)return new Promise(function(e){c._render_resolveFuncs||(c._render_resolveFuncs=[]);c._render_resolveFuncs.push(e);c.render_tmout||(c.render_tmout=setTimeout(function(){return c.render3D(0,b)},a))});this.render_tmout||(this.render_tmout=setTimeout(function(){return c.render3D(0,
b)},a));return this}this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout);n.beforeRender3D(this._renderer);e=new Date;this.testCameraPosition(-1===a);this._webgl&&this._effectComposer&&0<this._effectComposer.passes.length?this._effectComposer.render():(this._webgl&&this._bloomComposer&&0<this._bloomComposer.passes.length&&(this._renderer.clear(),this._camera.layers.set(1),this._bloomComposer.render(),this._renderer.clearDepth(),this._camera.layers.set(0)),this._renderer.render(this._scene,
this._camera));var d=new Date;this.last_render_tm=d.getTime();0===this.first_render_tm&&b&&(this.first_render_tm=d.getTime()-e.getTime(),console.log("three.js r"+f.REVISION+", first render tm = "+this.first_render_tm));n.afterRender3D(this._renderer);this._render_resolveFuncs&&(this._render_resolveFuncs.forEach(function(a){return a(c)}),delete this._render_resolveFuncs)};d.prototype.startWorker=function(){if(!this._worker){this._worker_ready=!1;this._worker_jobs=0;var a=this;this._worker=new Worker(JSROOT.source_dir+
"scripts/JSRoot.geoworker.js");this._worker.onmessage=function(b){if("object"===typeof b.data){if("log"in b.data)return console.log("geo: "+b.data.log);if("progress"in b.data)return n.showProgress(b.data.progress);b.data.tm3=(new Date).getTime();"init"in b.data?(a._worker_ready=!0,console.log("Worker ready: "+(b.data.tm3-b.data.tm0))):a.processWorkerReply(b.data)}};this._worker.postMessage({init:!0,browser:JSROOT.browser,tm0:(new Date).getTime(),vislevel:this._clones.getVisLevel(),maxvisnodes:this._clones.getMaxVisNodes(),
clones:this._clones.nodes,sortmap:this._clones.sortmap})}};d.prototype.canSubmitToWorker=function(a){return this._worker?this._worker_ready&&(0==this._worker_jobs||a):!1};d.prototype.submitToWorker=function(a){if(!this._worker)return!1;this._worker_jobs++;a.tm0=(new Date).getTime();this._worker.postMessage(a)};d.prototype.processWorkerReply=function(a){this._worker_jobs--;if("collect"in a)return this._new_draw_nodes=a.new_nodes,this._draw_all_nodes=a.complete,this.drawing_stage=3,this.continueDraw();
if("shapes"in a){for(var b=0;b<a.shapes.length;++b){var c=a.shapes[b],e=this._build_shapes[b];c.buf_pos&&c.buf_norm&&(0===c.buf_pos.length?e.geom=null:c.buf_pos.length!==c.buf_norm.length?(console.error("item.buf_pos",c.buf_pos.length,"item.buf_norm",c.buf_norm.length),e.geom=null):(e.geom=new f.BufferGeometry,e.geom.setAttribute("position",new f.BufferAttribute(c.buf_pos,3)),e.geom.setAttribute("normal",new f.BufferAttribute(c.buf_norm,3))),e.ready=!0,e.nfaces=c.nfaces)}a.tm4=(new Date).getTime();
this.drawing_stage=7;return this.continueDraw()}};d.prototype.testGeomChanges=function(){if(this._main_painter)return console.warn("Get testGeomChanges call for slave painter"),this._main_painter.testGeomChanges();this.startDrawGeometry();for(var a=0;a<this._slave_painters.length;++a)this._slave_painters[a].startDrawGeometry()};d.prototype.drawSimpleAxis=function(a){this.getExtrasContainer("delete","axis");if(!this.ctrl._axis)return a?null:this.render3D();var b=this.getGeomBoundingBox(this._toplevel),
c=this.getExtrasContainer("create","axis"),e=.02*Math.max(b.max.x-b.min.x,b.max.y-b.min.y,b.max.z-b.min.z),d=[0,0,0],g=["x","y","z"],r=["X","Y","Z"],m=["red","green","blue"],p=this.ctrl.ortho_camera,l=[this.ctrl._yup,this.ctrl._yup,this.ctrl._yup],t=3;if(2==this.ctrl._axis)for(var u=0;3>u;++u){var w=g[u];0>=b.min[w]&&0<=b.max[w]||(d[u]=(b.min[w]+b.max[w])/2)}this.ctrl.ortho_camera&&(t=2,r[0]=r[2],m[0]=m[2],l[0]=l[2],p=!0);u={};for(w=0;w<t;u={$jscomp$loop$prop$name$13$18:u.$jscomp$loop$prop$name$13$18},
++w){var y=function(a){return function(c){return 2>b.max[a.$jscomp$loop$prop$name$13$18]-b.min[a.$jscomp$loop$prop$name$13$18]?c.toFixed(3):1E5<Math.abs(c)?c.toExponential(3):Math.round(c).toString()}}(u),x=new Float32Array(6),A=m[w];u.$jscomp$loop$prop$name$13$18=g[w];var v=y(b.max[u.$jscomp$loop$prop$name$13$18]);x[0]=b.min.x;x[1]=b.min.y;x[2]=b.min.z;x[3]=b.min.x;x[4]=b.min.y;x[5]=b.min.z;switch(w){case 0:x[3]=b.max.x;v=l[0]&&!p?r[0]+" "+v:v+(" "+r[0]);break;case 1:x[4]=b.max.y;v=l[1]?v+(" "+r[1]):
r[1]+" "+v;break;case 2:x[5]=b.max.z,v+=" "+r[2]}if(2==this.ctrl._axis)for(var q=0;6>q;++q)q%3!==w&&(x[q]=d[q%3]);q=new f.LineBasicMaterial({color:A});q=n.createLineSegments(x,q);c.add(q);A=new f.MeshBasicMaterial({color:A});0===d[w]&&d[w]>=b.min[u.$jscomp$loop$prop$name$13$18]&&d[w]<=b.max[u.$jscomp$loop$prop$name$13$18]&&(2!=this.ctrl._axis||0===w)&&(q=p?new f.CircleBufferGeometry(.25*e):new f.SphereBufferGeometry(.25*e),q=new f.Mesh(q,A),q.translateX(0===w?d[0]:x[0]),q.translateY(1===w?d[1]:x[1]),
q.translateZ(2===w?d[2]:x[2]),c.add(q));v=new f.TextGeometry(v,{font:JSROOT.threejs_font_helvetiker_regular,size:e,height:0,curveSegments:5});q=new f.Mesh(v,A);v=(new f.Box3).setFromObject(q);q.translateX(x[3]);q.translateY(x[4]);q.translateZ(x[5]);if(l[w])switch(w){case 0:p?q.translateX(.5*e):(q.rotateY(Math.PI),q.translateX(-v.max.x-.5*e));q.translateY(-v.max.y/2);break;case 1:p?q.rotateZ(Math.PI/2):(q.rotateX(-Math.PI/2),q.rotateY(-Math.PI/2));q.translateX(.5*e);q.translateY(-v.max.y/2);break;
case 2:q.rotateY(-Math.PI/2),q.translateX(.5*e),q.translateY(-v.max.y/2)}else switch(w){case 0:q.rotateX(Math.PI/2);q.translateY(-v.max.y/2);q.translateX(.5*e);break;case 1:q.rotateX(Math.PI/2);q.rotateY(-Math.PI/2);q.translateX(-v.max.x-.5*e);q.translateY(-v.max.y/2);break;case 2:q.rotateX(Math.PI/2),q.rotateZ(Math.PI/2),q.translateX(.5*e),q.translateY(-v.max.y/2)}c.add(q);v=new f.TextGeometry(y(b.min[u.$jscomp$loop$prop$name$13$18]),{font:JSROOT.threejs_font_helvetiker_regular,size:e,height:0,curveSegments:5});
q=new f.Mesh(v,A);v=(new f.Box3).setFromObject(q);q.translateX(x[0]);q.translateY(x[1]);q.translateZ(x[2]);if(l[w])switch(w){case 0:p?q.translateX(-v.max.x-.5*e):(q.rotateY(Math.PI),q.translateX(.5*e));q.translateY(-v.max.y/2);break;case 1:p?q.rotateZ(Math.PI/2):(q.rotateX(-Math.PI/2),q.rotateY(-Math.PI/2));q.translateY(-v.max.y/2);q.translateX(-v.max.x-.5*e);break;case 2:q.rotateY(-Math.PI/2),q.translateX(-v.max.x-.5*e),q.translateY(-v.max.y/2)}else switch(w){case 0:q.rotateX(Math.PI/2);q.translateX(-v.max.x-
.5*e);q.translateY(-v.max.y/2);break;case 1:q.rotateX(Math.PI/2);q.rotateY(-Math.PI/2);q.translateY(-v.max.y/2);q.translateX(.5*e);break;case 2:q.rotateX(Math.PI/2),q.rotateZ(Math.PI/2),q.translateX(-v.max.x-.5*e),q.translateY(-v.max.y/2)}c.add(q)}this.changedDepthMethod(a?"norender":void 0)};d.prototype.toggleAxesDraw=function(){this.setAxesDraw("toggle")};d.prototype.setAxesDraw=function(a){this.ctrl._axis="toggle"===a?this.ctrl._axis?0:1:"number"==typeof a?a:a?1:0;this.drawSimpleAxis()};d.prototype.setAutoRotate=
function(a){this.ctrl.project||(void 0!==a&&(this.ctrl.rotate=a),this.autorotate(2.5))};d.prototype.toggleWireFrame=function(){this.ctrl.wireframe=!this.ctrl.wireframe;this.changedWireFrame()};d.prototype.setWireFrame=function(a){this.ctrl.wireframe=a?!0:!1;this.changedWireFrame()};d.prototype.setShowTop=function(a){this.ctrl.showtop=a?!0:!1;this.redrawObject("same")};d.prototype.changedClipping=function(a){var b=this.ctrl.clip;if(!(void 0!==a&&0<=a)||b[a].enabled){if(b[0].enabled||b[1].enabled||
b[2].enabled)this.ctrl.ssao.enabled=!1,this.removeSSAO();this.updateClipping(!1,!0)}};d.prototype.changedDepthTest=function(){if(this._toplevel){var a=this.ctrl.depthTest;this._toplevel.traverse(function(b){b instanceof f.Mesh&&(b.material.depthTest=a)});this.render3D(0)}};d.prototype.changedDepthMethod=function(a){delete this._last_camera_position;"norender"!==a&&this.render3D()};d.prototype.changedHighlight=function(){this.ctrl.highlight||this.highlightMesh(null)};d.prototype.updateClipping=function(a,
b){if(!this._renderer||this._renderer.jsroot_render3d!==JSROOT.constants.Render3D.SVG){for(var c=this.ctrl.clip,e=[],d=!1,g=[c[0].value,-1*c[1].value,(this.ctrl._yup?-1:1)*c[2].value],n=this.ctrl.clipIntersect?16:0,m=0;3>m;++m)c[m].enabled&&(n+=2<<m),this._clipPlanes[m].constant!=g[m]&&(d=!0,this._clipPlanes[m].constant=g[m]);this.ctrl.ssao.enabled||(c[0].enabled&&e.push(this._clipPlanes[0]),c[1].enabled&&e.push(this._clipPlanes[1]),c[2].enabled&&e.push(this._clipPlanes[2]),n+=1E3*e.length);0==e.length&&
(e=null);this._clipCfg!==n&&(d=!0);this._clipCfg=n;c=!!e;var p=this.ctrl.clipIntersect,l=c?f.DoubleSide:f.FrontSide;(b||d)&&this._scene.traverse(function(a){a.hasOwnProperty("material")&&a.material&&void 0!==a.material.clippingPlanes&&(a.material.clippingPlanes!==e&&(a.material.clipIntersection=p,a.material.clippingPlanes=e,a.material.needsUpdate=!0),void 0!==a.material.emissive&&a.material.side!=l&&(a.material.side=l,a.material.needsUpdate=!0))});this.ctrl.bothSides=c;a||this.render3D(0);return d}};
d.prototype.setCompleteHandler=function(a){this._complete_handler=a};d.prototype.completeDraw=function(a){var b=this,c=!1,e=!1,d=!0;if(!this.ctrl)return console.warn("ctrl object does not exist in completeDraw - something went wrong"),Promise.resolve(this);var f=Promise.resolve(!0);this._clones?(this._first_drawing||this._full_redrawing)&&this.ctrl.tracks&&this.geo_manager&&(f=this.drawExtras(this.geo_manager.fTracks,"<prnt>/Tracks")):(d=!1,this.getExtrasContainer("delete"),f=this.drawExtras((this._main_painter?
this._main_painter._extraObjects:null)||this._extraObjects,"",!1));return f.then(function(){b._full_redrawing&&(b.adjustCameraPosition(!0),b._full_redrawing=!1,e=!0,b.changedDepthMethod("norender"));b._first_drawing&&(b.adjustCameraPosition(!0),b.showDrawInfo(),b._first_drawing=!1,e=c=!0);0!==b.ctrl.transparency&&b.changedGlobalTransparency(b.ctrl.transparency,!0);c&&b.completeScene();e&&(b.ctrl.trans_radial||b.ctrl.trans_z)&&b.changedTransformation("norender");e&&b.ctrl._axis&&b.drawSimpleAxis(!0);
b._scene.overrideMaterial=null;void 0!==b._provided_more_nodes&&(b.appendMoreNodes(b._provided_more_nodes,!0),delete b._provided_more_nodes);if(d)return b.getExtrasContainer("delete"),b.drawExtras((b._main_painter?b._main_painter._extraObjects:null)||b._extraObjects,"",!1)}).then(function(){b.updateClipping(!0);b.render3D(0,!0);a&&n.showProgress();b.addOrbitControls();b.addTransformControl();c&&(!1===b.ctrl.highlight&&(b.ctrl.highlight=1E3>b.first_render_tm),!1===b.ctrl.highlight_scene&&(b.ctrl.highlight_scene=
b.ctrl.highlight),b._webgl&&b.ctrl.rotate&&!b.ctrl.project&&b.autorotate(2.5),b._webgl&&b.ctrl.show_controls&&!JSROOT.batch_mode&&b.showControlOptions(!0));b.setAsMainPainter();"function"==typeof b._resolveFunc&&(b._resolveFunc(b),delete b._resolveFunc);"function"==typeof b._complete_handler&&b._complete_handler(b);b._draw_nodes_again?b.startDrawGeometry():b._drawing_ready=!0;return b})};d.prototype.isDrawingReady=function(){return this._drawing_ready||!1};d.prototype.removeDrawnNode=function(a){if(this._draw_nodes){for(var b=
[],c=0;c<this._draw_nodes.length;++c){var e=this._draw_nodes[c];e.nodeid===a||this._clones.isIdInStack(a,e.stack)?this._clones.createObject3D(e.stack,this._toplevel,"delete_mesh"):b.push(e)}b.length<this._draw_nodes.length&&(this._draw_nodes=b,this.render3D())}};d.prototype.cleanup=function(a){var b=this;if(!a){this.removeSSAO();this.clearTopPainter();a=0;if(this._on_pad){var c=this.getFramePainter();c&&c.mode3d&&(c.clear3dCanvas(),c.mode3d=!1)}else a=this.clear3dCanvas();this._toolbar&&this._toolbar.cleanup();
this.helpText();n.disposeThreejsObject(this._scene);n.disposeThreejsObject(this._full_geom);this._tcontrols&&this._tcontrols.dispose();this._controls&&this._controls.cleanup();this._context_menu&&this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,!1);this._datgui&&this._datgui.destroy();this._worker&&this._worker.terminate();delete this._animating;(c=this.getGeometry())&&this.ctrl.is_main&&(c.$geo_painter===this?delete c.$geo_painter:c.fVolume&&c.fVolume.$geo_painter===
this&&delete c.fVolume.$geo_painter);this._main_painter&&(c=this._main_painter._slave_painters.indexOf(this),0<=c&&this._main_painter._slave_painters.splice(c,1));for(c=0;c<this._slave_painters.length;++c){var e=this._slave_painters[c];e&&e._main_painter===this&&(e._main_painter=null)}delete this.geo_manager;delete this._highlight_handlers;JSROOT.ObjectPainter.prototype.cleanup.call(this);delete this.ctrl;delete this.options;this.did_cleanup=!0;0>a&&this.selectDom().html("")}if(this._slave_painters)for(var d in this._slave_painters)a=
this._slave_painters[d],a._main_painter=null,a._clones===this._clones&&(a._clones=null);this._main_painter=null;this._slave_painters=[];this._render_resolveFuncs&&(this._render_resolveFuncs.forEach(function(a){return a(b)}),delete this._render_resolveFuncs);n.cleanupRender3D(this._renderer);delete this._scene;this._scene_height=this._scene_width=0;this._toplevel=this._renderer=null;delete this._full_geom;delete this._camera;delete this._camera0pos;delete this._lookat;delete this._selected_mesh;this._clones&&
this._clones_owner&&this._clones.cleanup(this._draw_nodes,this._build_shapes);delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._new_draw_nodes;delete this._new_append_nodes;delete this._last_camera_position;this.drawing_stage=this.last_render_tm=this.first_render_tm=0;delete this.drawing_log;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;delete this._worker};
d.prototype.helpText=function(a){n.showProgress(a)};d.prototype.performResize=function(a,b){if(this._scene_width===a&&this._scene_height===b||10>a||10>b)return!1;this._scene_width=a;this._scene_height=b;this._camera&&this._renderer&&("PerspectiveCamera"==this._camera.type&&(this._camera.aspect=this._scene_width/this._scene_height),this._camera.updateProjectionMatrix(),this._renderer.setSize(this._scene_width,this._scene_height,!this._fit_main_area),this._effectComposer&&this._effectComposer.setSize(this._scene_width,
this._scene_height),this._bloomComposer&&this._bloomComposer.setSize(this._scene_width,this._scene_height),this.drawing_stage||this.render3D());return!0};d.prototype.checkResize=function(a){var b=this.getCanvPainter();if(b&&!b.checkCanvasResize(a))return!1;a=this.getSizeFor3d();return this.performResize(a.width,a.height)};d.prototype.toggleEnlarge=function(){this.enlargeMain("toggle")&&this.checkResize()};d.prototype.ownedByTransformControls=function(a){for(a=a.parent;a&&!(a instanceof f.TransformControls);)a=
a.parent;return a&&a instanceof f.TransformControls};d.prototype.accessObjectWireFrame=function(a,b){if(a.hasOwnProperty("material")&&!(a instanceof f.GridHelper)&&!this.ownedByTransformControls(a))return void 0!==b&&a.stack&&(a.material.wireframe=b),a.material.wireframe};d.prototype.changedWireFrame=function(){var a=this;if(this._scene){var b=this.ctrl.wireframe;this._scene.traverse(function(c){return a.accessObjectWireFrame(c,b)});this.render3D()}};d.prototype.updateObject=function(a){if("same"===
a)return!0;if(!a||!a._typename)return!1;if(a===this.getObject())return!0;if(this.geo_manager&&"TGeoManager"==a._typename)return this.geo_manager=a,this.assignObject({_typename:"TGeoNode",fVolume:a.fMasterVolume,fName:a.fMasterVolume.fName,$geoh:a.fMasterVolume.$geoh,_proxy:!0}),!0;if(!this.matchObjectType(a._typename))return!1;this.assignObject(a);return!0};d.prototype.clearDrawings=function(){this._clones&&this._clones_owner&&this._clones.cleanup(this._draw_nodes,this._build_shapes);delete this._clones;
delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._extraObjects;delete this._clipCfg;n.disposeThreejsObject(this._toplevel,!0);this._full_redrawing=!0};d.prototype.redrawObject=function(a){if(!this.updateObject(a))return!1;this.clearDrawings();a=this.getGeometry();var b="";this.geo_manager&&(b=a.fName);this.prepareObjectDraw(a,b);return!0};d.prototype.redraw=function(a){if(this._on_pad&&"resize"==a&&(a=this.getFramePainter())){var b=
a.getSizeFor3d(a.access3dKind());a.apply3dSize(b);return this.performResize(b.width,b.height)}};n.createGeoPainter=function(a,b,c){g.GradPerSegm=JSROOT.settings.GeoGradPerSegm;g.CompressComp=JSROOT.settings.GeoCompressComp;a=new d(a,b);a.options=a.decodeOptions(c);JSROOT.extend(a.ctrl,a.options);a.ctrl.ssao.enabled=a.options.usessao;a.ctrl.bloom.enabled=a.options.usebloom;a.ctrl.clip[0].enabled=a.options.clipx;a.ctrl.clip[1].enabled=a.options.clipy;a.ctrl.clip[2].enabled=a.options.clipz;return a};
var B=function(a,b,c){if(!b)return null;var e=null,d=null,f="",r=!1;"fShapeBits"in b&&"fShapeId"in b?(e=b,b=null):"TGeoVolumeAssembly"===b._typename||"TGeoVolume"===b._typename?e=b.fShape:"TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::REveGeoShapeExtract"===b._typename?(e=b.fShape,r=!0):"TGeoManager"===b._typename?e=b.fMasterVolume.fShape:"TGeoOverlap"===b._typename?(d=b.fMarker,f="<prnt>/Marker",b=g.buildOverlapVolume(b),c||(c="wire")):"fVolume"in b?b.fVolume&&(e=b.fVolume.fShape):b=null;
"string"==typeof c&&0==c.indexOf("comp")&&e&&"TGeoCompositeShape"==e._typename&&e.fNode&&(b=1,c=c.substr(4),"x"==c[0]&&(b=999,c=c.substr(1)+"_vislvl999"),b=g.buildCompositeVolume(e,b));!b&&e&&(b=JSROOT.extend(JSROOT.create("TEveGeoShapeExtract"),{fTrans:null,fShape:e,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!b)return null;var m=n.createGeoPainter(a,b,c);m.ctrl.is_main&&!b.$geo_painter&&(b.$geo_painter=m);!m.ctrl.is_main&&m.ctrl.project&&b.$geo_painter&&(m._main_painter=b.$geo_painter,m._main_painter._slave_painters.push(m));
if(r&&!m.ctrl.vislevel||9>m.ctrl.vislevel)m.ctrl.vislevel=9;d&&(m._splitColors=!0,m.addExtra(d,f));return m.loadMacro(m.ctrl.script_name).then(function(a){return m.prepareObjectDraw(a.obj,a.prefix)})};g.buildCompositeVolume=function(a,b,c){void 0===b&&(b=1);c||(this.$comp_col_cnt=0,c="");var e=JSROOT.create("TGeoVolume");g.SetBit(e,g.BITS.kVisThis,!0);g.SetBit(e,g.BITS.kVisDaughters,!0);if(c&&"TGeoCompositeShape"!==a._typename||0>=b)return e.fName=c,e.fLineColor=this.$comp_col_cnt++%8+2,e.fShape=
a,e;c&&(c+="/");e.$geoh=!0;e.fName="";var d=JSROOT.create("TGeoNodeMatrix");g.SetBit(d,g.BITS.kVisThis,!0);g.SetBit(d,g.BITS.kVisDaughters,!0);d.fName="Left";d.fMatrix=a.fNode.fLeftMat;d.fVolume=g.buildCompositeVolume(a.fNode.fLeft,b-1,c+"Left");var f=JSROOT.create("TGeoNodeMatrix");g.SetBit(f,g.BITS.kVisThis,!0);g.SetBit(f,g.BITS.kVisDaughters,!0);f.fName="Right";f.fMatrix=a.fNode.fRightMat;f.fVolume=g.buildCompositeVolume(a.fNode.fRight,b-1,c+"Right");e.fNodes=JSROOT.create("TList");e.fNodes.Add(d);
e.fNodes.Add(f);c||delete this.$comp_col_cnt;return e};g.buildOverlapVolume=function(a){var b=JSROOT.create("TGeoVolume");g.SetBit(b,g.BITS.kVisDaughters,!0);b.$geoh=!0;b.fName="";var c=JSROOT.create("TGeoNodeMatrix");c.fName=a.fVolume1.fName||"Overlap1";c.fMatrix=a.fMatrix1;c.fVolume=a.fVolume1;var e=JSROOT.create("TGeoNodeMatrix");e.fName=a.fVolume2.fName||"Overlap2";e.fMatrix=a.fMatrix2;e.fVolume=a.fVolume2;b.fNodes=JSROOT.create("TList");b.fNodes.Add(c);b.fNodes.Add(e);return b};g.provideVisStyle=
function(a){if("TEveGeoShapeExtract"===a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename)return a.fRnrSelf?" geovis_this":"";var b=!g.TestBit(a,g.BITS.kVisNone)&&g.TestBit(a,g.BITS.kVisThis),c=g.TestBit(a,g.BITS.kVisDaughters);!c||a.fNodes&&0!==a.fNodes.arr.length||(c=!1);return b&&c?" geovis_all":b?" geovis_this":c?" geovis_daughters":""};g.createItem=function(a,b,c){c={_kind:"ROOT."+b._typename,_name:c?c:g.getObjectName(b),_title:b.fTitle,_parent:a,_geoobj:b,_get:function(a){a._geoobj&&
(a._geoobj.$geoh=!0);return Promise.resolve(a._geoobj)}};var e=!1;if("TGeoMaterial"==b._typename)c._icon="img_geomaterial";else if("TGeoMedium"==b._typename)c._icon="img_geomedium";else if("TGeoMixture"==b._typename)c._icon="img_geomixture";else if(0===b._typename.indexOf("TGeoNode")&&b.fVolume){c._title="node:"+b._typename;0<b.fTitle.length&&(c._title+=" "+b.fTitle);var d=b.fVolume}else if(0===b._typename.indexOf("TGeoVolume"))d=b;else if("TEveGeoShapeExtract"==b._typename||"ROOT::Experimental::REveGeoShapeExtract"==
b._typename){e=!0;var f=b.fShape;var n=b.fElements?b.fElements.arr:null}else void 0!==b.fShapeBits&&void 0!==b.fShapeId&&(f=b);d&&(f=d.fShape,n=d.fNodes?d.fNodes.arr:null);if(d||f||n)d&&(c._volume=d),n?(c._more=!0,c._expand=g.expandObject):f&&"TGeoCompositeShape"===f._typename&&f.fNode&&(c._more=!0,c._shape=f,c._expand=function(a){g.createItem(a,a._shape.fNode.fLeft,"Left");g.createItem(a,a._shape.fNode.fRight,"Right");return!0}),c._title||"TGeoVolume"==b._typename||(c._title=b._typename),f?(""==
c._title&&(c._title=f._typename),c._icon=g.getShapeIcon(f)):c._icon=c._more?"img_geocombi":"img_geobbox",d?c._icon+=g.provideVisStyle(d):e&&(c._icon+=g.provideVisStyle(b)),c._menu=g.provideMenu,c._icon_click=g.browserIconClick;a._childs||(a._childs=[]);c._name||("string"===typeof a._name?(c._name=a._name,c._name.lastIndexOf("s")===c._name.length-1&&(c._name=c._name.substr(0,c._name.length-1)),c._name+="_"+a._childs.length):c._name="item_"+a._childs.length);a._childs.push(c);return c};g.createList=
function(a,b,c,d){b&&"arr"in b&&0!=b.arr.length&&(b={_name:c,_kind:"ROOT.TList",_title:d,_more:!0,_geoobj:b,_parent:a,_get:function(a){return Promise.resolve(a._geoobj||null)},_expand:function(a,b){"fVolume"in b&&(b=b.fVolume.fNodes);if(!("arr"in b))return!1;a._childs=[];g.checkDuplicates(null,b.arr);for(var c in b.arr)g.createItem(a,b.arr[c]);return!0}},a._childs||(a._childs=[]),a._childs.push(b))};g.provideMenu=function(a,b,c){function d(a,b,c){b||(b={visible:0,hidden:0});c||(void 0!==b.assign?
a.fRnrSelf=b.assign:a.fRnrSelf?b.vis++:b.hidden++);if(a.fElements)for(c=0;c<a.fElements.arr.length;++c)d(a.fElements.arr[c],b,!1);return b}function f(a){"self"===a?(n.fRnrSelf=!n.fRnrSelf,b._icon=b._icon.split(" ")[0]+g.provideVisStyle(n),c.updateTreeNode(b)):(d(n,{assign:"true"===a},!0),c.forEachItem(function(a){a._geoobj&&a._icon&&(a._icon=b._icon.split(" ")[0]+g.provideVisStyle(a._geoobj),c.updateTreeNode(a))},b));g.findItemWithPainter(b,"testGeomChanges")}function k(a){g.ToggleBit(m,a);var d=
b._icon.split(" ")[0]+g.provideVisStyle(m);c.forEachItem(function(a){b._volume===a._volume&&(a._icon=d,c.updateTreeNode(a))});c.updateTreeNode(b);g.findItemWithPainter(b,"testGeomChanges")}if(!b._geoobj)return!1;var n=b._geoobj,m=b._volume,p="TEveGeoShapeExtract"===n._typename||"ROOT::Experimental::REveGeoShapeExtract"===n._typename;if(!m&&!p)return!1;a.add("separator");0===b._geoobj._typename.indexOf("TGeoNode")&&g.findItemWithPainter(b)&&a.add("Focus",function(){var a=g.findItemWithPainter(b);if(a){var d=
c.itemFullName(b,a);a._painter&&"function"==typeof a._painter.focusOnItem&&a._painter.focusOnItem(d)}});p?(a.addchk(n.fRnrSelf,"Visible","self",f),p=d(n,void 0,!0),0<p.hidden+p.visible&&a.addchk(0==p.hidden,"Daughters",0!=p.hidden?"true":"false",f)):(a.addchk(g.TestBit(m,g.BITS.kVisNone),"Invisible",g.BITS.kVisNone,k),a.addchk(g.TestBit(m,g.BITS.kVisThis),"Visible",g.BITS.kVisThis,k),a.addchk(g.TestBit(m,g.BITS.kVisDaughters),"Daughters",g.BITS.kVisDaughters,k));return!0};g.findItemWithPainter=function(a,
b){for(;a;){if(a._painter&&a._painter._camera){if(b&&"function"==typeof a._painter[b])a._painter[b]();return a}a=a._parent}return null};g.updateBrowserIcons=function(a,b){a&&b&&b.forEachItem(function(c){if(a===c._volume||a===c._geoobj)c._icon=c._icon.split(" ")[0]+g.provideVisStyle(a),b.updateTreeNode(c)})};g.browserIconClick=function(a,b){if(a._volume)return a._more&&a._volume.fNodes&&0<a._volume.fNodes.arr.length?g.ToggleBit(a._volume,g.BITS.kVisDaughters):g.ToggleBit(a._volume,g.BITS.kVisThis),
g.updateBrowserIcons(a._volume,b),g.findItemWithPainter(a,"testGeomChanges"),!1;if(a._geoobj&&("TEveGeoShapeExtract"==a._geoobj._typename||"ROOT::Experimental::REveGeoShapeExtract"==a._geoobj._typename))return a._geoobj.fRnrSelf=!a._geoobj.fRnrSelf,g.updateBrowserIcons(a._geoobj,b),g.findItemWithPainter(a,"testGeomChanges"),!1;var c=g.findItemWithPainter(a);return c?void 0!==c._painter.extraObjectVisible(b,a,!0)?!0:!1:!1};g.getShapeIcon=function(a){switch(a._typename){case "TGeoArb8":return"img_geoarb8";
case "TGeoCone":return"img_geocone";case "TGeoConeSeg":return"img_geoconeseg";case "TGeoCompositeShape":return"img_geocomposite";case "TGeoTubeSeg":return"img_geotubeseg";case "TGeoPara":return"img_geopara";case "TGeoParaboloid":return"img_geoparab";case "TGeoPcon":return"img_geopcon";case "TGeoPgon":return"img_geopgon";case "TGeoShapeAssembly":return"img_geoassembly";case "TGeoSphere":return"img_geosphere";case "TGeoTorus":return"img_geotorus";case "TGeoTrd1":return"img_geotrd1";case "TGeoTrd2":return"img_geotrd2";
case "TGeoXtru":return"img_geoxtru";case "TGeoTrap":return"img_geotrap";case "TGeoGtra":return"img_geogtra";case "TGeoEltu":return"img_geoeltu";case "TGeoHype":return"img_geohype";case "TGeoCtub":return"img_geoctub"}return"img_geotube"};g.getBrowserIcon=function(a,b){var c="";"ROOT.TEveTrack"==a._kind?c="img_evetrack":"ROOT.TEvePointSet"==a._kind?c="img_evepoints":"ROOT.TPolyMarker3D"==a._kind&&(c="img_evepoints");if(0<c.length){var d=g.findItemWithPainter(a);d&&d._painter.extraObjectVisible(b,a)&&
(c+=" geovis_this")}return c};g.expandObject=function(a,b){if(!a||!b)return!1;var c=0===b._typename.indexOf("TGeoNode"),d=0===b._typename.indexOf("TGeoVolume"),f="TGeoManager"===b._typename,k="TEveGeoShapeExtract"===b._typename||"ROOT::Experimental::REveGeoShapeExtract"===b._typename,n="TGeoOverlap"===b._typename;if(!(c||d||f||k||n))return!1;if(a._childs)return!0;if(f)return g.createList(a,b.fMaterials,"Materials","list of materials"),g.createList(a,b.fMedia,"Media","list of media"),g.createList(a,
b.fTracks,"Tracks","list of tracks"),g.createList(a,b.fOverlaps,"Overlaps","list of detected overlaps"),g.createItem(a,b.fMasterVolume),!0;if(n)return g.createItem(a,b.fVolume1),g.createItem(a,b.fVolume2),g.createItem(a,b.fMarker,"Marker"),!0;k?(c=b.fElements?b.fElements.arr:null,d=b.fShape):(c=(d=c?b.fVolume:b)&&d.fNodes?d.fNodes.arr:null,d=d?d.fShape:null);if(!c&&d&&"TGeoCompositeShape"===d._typename&&d.fNode)return a._childs||(g.createItem(a,d.fNode.fLeft,"Left"),g.createItem(a,d.fNode.fRight,
"Right")),!0;if(!c)return!1;g.checkDuplicates(b,c);for(b=0;b<c.length;++b)g.createItem(a,c[b]);return!0};n.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:B,expand:g.expandObject,opt:";more;all;count"});n.addDrawFunc({name:"TEvePointSet",icon_get:g.getBrowserIcon,icon_click:g.browserIconClick});n.addDrawFunc({name:"TEveTrack",icon_get:g.getBrowserIcon,icon_click:g.browserIconClick});JSROOT.TGeoPainter=d;n.GeoDrawingControl=y;n.drawGeoObject=B;JSROOT.nodejs&&(module.exports=g);return g});
